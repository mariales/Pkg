(self.webpackChunkapp_studio_enterprise_pivot_table=self.webpackChunkapp_studio_enterprise_pivot_table||[]).push([[7603],{37603:(b,D,c)=>{c.r(D),c.d(D,{BaseEntityService:()=>w,DataServiceQueryExecutor:()=>Q,DataServiceQueryExecutorModule:()=>_,EsqServerCacheLevels:()=>v,InvalidQueryResponseException:()=>C,InvalidResponseException:()=>p,LegacyDataServiceQueryExecutor:()=>f,LegacyDataServiceQueryExecutorModule:()=>I,QueryExecutor:()=>u,QueryKind:()=>m,QuerySource:()=>g,ServerESQCacheParameters:()=>R});var n=c(38495),y=c(62278),i=c(36486);class w{constructor(e,t,r){this.queryExecutor=e,this._translateService=t,this.entityConverter=r,this.absentDataErrorKey="BaseSection.AbsentDataErrorMessage",this.primaryColumnName="Id"}_convertToErrorInfo(e){return{errorCode:null,message:e.message,stackTrace:e.stack}}_addColumnsToEsq(e){this.entityConverter.getEntityColumns({}).forEach(r=>{e.addSchemaColumn(r.path)})}_createDeleteQuery(){return new n.DeleteQuery(this.entitySchemaName)}getBaseErrorResponse(e){return(0,y.of)({success:!1,errorInfo:this._convertToErrorInfo(e),result:null})}handleResponse(e){return e.pipe((0,i.map)(()=>({success:!0,errorInfo:null,result:[]})),(0,i.catchError)(t=>(0,y.of)({success:!1,errorInfo:this._convertToErrorInfo(t),result:[]})))}getItemByIdEsq(e){const t=new n.EntitySchemaQuery(this.entitySchemaName);return this._addColumnsToEsq(t),t.filters.addSchemaColumnFilterWithParameter(n.ComparisonType.Equal,this.primaryColumnName,e),t}createGetAllItemsEsq(){const e=new n.EntitySchemaQuery(this.entitySchemaName);return this._addColumnsToEsq(e),e}getUpdateQuery(e){const t=new n.UpdateQuery(this.entitySchemaName);return this.entityConverter.getEntityColumns(e).forEach(s=>{this.primaryColumnName===s.path?t.filters.addSchemaColumnFilterWithParameter(n.ComparisonType.Equal,this.primaryColumnName,s.value):t.addColumn(s.path,s.value,s.type)}),t}getInsertQuery(e){const t=new n.InsertQuery(this.entitySchemaName);return this.entityConverter.getEntityColumns(e).forEach(s=>{this.primaryColumnName===s.path&&!s.value||t.addColumn(s.path,s.value,s.type)}),t}getDeleteQuery(e){return this.getDeleteQueryWithPrimaryColumnFilter(e.id)}getDeleteQueryWithPrimaryColumnFilter(e){const t=this._createDeleteQuery();return t.filters.addSchemaColumnFilterWithParameter(n.ComparisonType.Equal,this.primaryColumnName,e),t}loadAdditionalInfo(e){return(0,y.of)(e)}getItems(){const e=this.createGetAllItemsEsq();return this.queryExecutor.executeSelectQuery(e).pipe((0,i.mergeMap)(t=>this.loadAdditionalInfo(t)),(0,i.map)(t=>({success:!0,errorInfo:null,result:t.map(r=>this.entityConverter.getEntity(r))})),(0,i.catchError)(t=>this.getBaseErrorResponse(t)))}getItem(e){const t=this.getItemByIdEsq(e);return this.queryExecutor.executeSelectQuery(t).pipe((0,i.tap)(r=>{if(!(r&&r[0])){const s=this._translateService.instant(this.absentDataErrorKey);throw new Error(s)}}),(0,i.mergeMap)(r=>this.loadAdditionalInfo(r)),(0,i.map)(r=>({success:!0,errorInfo:null,result:[this.entityConverter.getEntity(r[0])]})),(0,i.catchError)(r=>this.getBaseErrorResponse(r)))}insertItem(e){const t=this.getInsertQuery(e),r=this.queryExecutor.executeInsertQuery(t);return this.handleResponse(r)}updateItem(e){const t=this.getUpdateQuery(e),r=this.queryExecutor.executeUpdateQuery(t);return this.handleResponse(r)}deleteItem(e){const t=this.getDeleteQuery(e),r=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(r)}deleteById(e){const t=this.getDeleteQueryWithPrimaryColumnFilter(e),r=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(r)}}var T=c(73308),d=c(5960),E=c(63721),o=c(59131),h=c(21018);class u{static{this.\u0275fac=function(t){return new(t||u)}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:u,factory:u.\u0275fac})}}var m;(function(a){a[a.General=0]="General",a[a.Limited=1]="Limited"})(m||(m={}));var g;(function(a){a[a.Undefined=0]="Undefined",a[a.Filter=1]="Filter",a[a.FilterSummary=2]="FilterSummary"})(g||(g={}));var v;(function(a){a[a.Session=0]="Session",a[a.Workspace=1]="Workspace",a[a.Application=2]="Application"})(v||(v={}));class R{constructor(e=v.Session,t="",r=""){this._cacheLevel=e,this._cacheGroup=t,this._cacheItemName=r}getMetadata(){return{cacheLevel:this._cacheLevel,cacheGroup:this._cacheGroup,cacheItemName:this._cacheItemName}}}class C extends Error{constructor(e){super(`Query with config
${JSON.stringify(e.getMetadata())}
finished with error.`)}}class p extends Error{constructor(e){const t=e?.error?.responseStatus?.Message||e?.responseStatus?.Message||e?.message;super(t),this.errorCode=e?.error?.responseStatus?.ErrorCode}}let f=class extends u{constructor(e,t,r){super(),this._sysSettingsService=e,this._httpClient=t,this._dataServiceUri=r,this._defaultDebounceTime=200,this._debounceTimeSysSettingName="QueryExecutorDebounceTime",this._requests=new y.Subject,n.ValidationUtilities.checkArgumentEmpty("_httpClient",t),n.ValidationUtilities.checkArgumentEmpty("_dataServiceUri",r)}_executeWritableQuery(e,t){const s={...e.getMetadata(),queryKind:m.General};return this._httpClient.post(t,s).pipe((0,i.catchError)(l=>{throw new p(l)}),(0,i.tap)(l=>{if(!(l&&l.success))throw new C(e)}))}_getQueryUri(e){if(e instanceof n.SelectLocalizationQuery)return`${this._dataServiceUri}/SelectLocalizationQuery`;if(e instanceof n.EntitySchemaQuery)return`${this._dataServiceUri}/SelectQuery`;if(e instanceof n.InsertQuery)return`${this._dataServiceUri}/InsertQuery`;if(e instanceof n.UpdateQuery)return`${this._dataServiceUri}/UpdateQuery`;if(e instanceof n.DeleteQuery)return`${this._dataServiceUri}/DeleteQuery`;throw new Error("Unsupported query type")}_getBundleSettings(){var e=this;return(0,T.A)(function*(){return e._sysSettingsService?{executionDebounceTime:(yield e._sysSettingsService.getByCodes([e._debounceTimeSysSettingName])).values[e._debounceTimeSysSettingName]?.value||e._defaultDebounceTime}:Promise.resolve({executionDebounceTime:e._defaultDebounceTime})})()}_prepareDebouncedResponsesStream(){if(this._responses)return;let e=0;const t=(0,i.buffer)(this._requests.pipe((0,i.switchMap)(()=>(0,y.from)(this._getBundleSettings())),(0,i.tap)(r=>e=r.executionDebounceTime),(0,i.debounceTime)(e)));this._responses=this._requests.pipe(t,(0,i.filter)(r=>!!r.length),(0,i.mergeMap)(r=>{const s=r.map(S=>S.id),l=r.map(S=>S.query);return this.executeBatchSelectQuery(l).pipe((0,i.map)(S=>s.reduce((q,A,M)=>q.set(A,S[M]),new Map)))}),(0,i.share)())}_executeThrottled(e){this._prepareDebouncedResponsesStream();const t={id:(0,n.generateGuid)(),query:e},r=this._responses.pipe((0,i.filter)(s=>s.has(t.id)),(0,i.map)(s=>s.get(t.id)),(0,i.take)(1));return r.subscribe(),this._requests.next(t),r}_executeImmediate(e){n.ValidationUtilities.checkArgumentEmpty("query",e);const t=this._getQueryUri(e),r=this._getQueryRequest(e);return this._httpClient.post(t,r).pipe((0,i.catchError)(s=>{throw new p(s)}),(0,i.tap)(s=>{if(!s?.rows)throw new C(e)}),(0,i.map)(s=>this._toSelectQueryResponse(s)))}_toSelectQueryResponse(e){const t=this.getRowsFromResponse(e);return t.rowsAffected=e.rowsAffected,e.errorInfo&&(t.errorInfo=e.errorInfo),t}_getQueryRequest(e){const t=e.getMetadata();return e instanceof n.EntitySchemaQuery?{...t,queryKind:m.General,serverESQCacheParameters:new R().getMetadata(),queryOptimize:!1,useMetrics:!1,querySource:g.Undefined}:{...t,queryKind:m.General}}getRowsFromResponse(e){return e.rows}executeSelectQuery(e,t={throttled:!1}){return t.throttled?this._executeThrottled(e):this._executeImmediate(e)}executeInsertQuery(e){return this.execute(e)}executeUpdateQuery(e){return this.execute(e)}executeDeleteQuery(e){return this.execute(e)}execute(e){n.ValidationUtilities.checkArgumentEmpty("query",e);const t=this._getQueryUri(e);return this._executeWritableQuery(e,t)}executeBatchSelectQuery(e){if(n.ValidationUtilities.checkArgumentEmpty("queries",e),e.length===0)return(0,y.of)([]);const t=`${this._dataServiceUri}/BatchQuery`,r={items:[]};return r.items=e.map(s=>({...this._getQueryRequest(s),__type:"Terrasoft.Nui.ServiceModel.DataContract.SelectQuery"})),this._httpClient.post(t,r).pipe((0,i.catchError)(s=>{throw new p(s)}),(0,i.tap)(s=>{if(!s||s.hasErrors)throw new p(s)}),(0,i.map)(s=>s.queryResults.map(l=>this._toSelectQueryResponse(l))))}};f=(0,d.__decorate)([(0,d.__param)(0,(0,o.Optional)()),(0,d.__param)(2,(0,o.Inject)(h.DATA_SERVICE_URI)),(0,d.__metadata)("design:paramtypes",[n.SysSettingsService,E.HttpClient,String])],f);var U=c(96590);let Q=class x extends f{constructor(e,t,r,s){super(e,t,s),this._entityDeserializer=r}getRowsFromResponse(e){return this._entityDeserializer.deserializeEntities(e.rowConfig,e.rows)}static{this.\u0275fac=function(t){return new(t||x)(o.\u0275\u0275inject(n.SysSettingsService,8),o.\u0275\u0275inject(E.HttpClient),o.\u0275\u0275inject(h.EntityDeserializer),o.\u0275\u0275inject(h.DATA_SERVICE_URI))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:x,factory:x.\u0275fac})}};Q=(0,d.__decorate)([(0,U.CrtHandlerChainAdapter)({requestType:"crt.DataServiceQueryExecutor"}),(0,d.__metadata)("design:paramtypes",[n.SysSettingsService,E.HttpClient,h.EntityDeserializer,String])],Q);class _{static{this.\u0275fac=function(t){return new(t||_)}}static{this.\u0275mod=o.\u0275\u0275defineNgModule({type:_})}static{this.\u0275inj=o.\u0275\u0275defineInjector({providers:[h.DATA_SERVICE_URI_PROVIDER,{provide:u,useClass:Q}]})}}class I{static{this.\u0275fac=function(t){return new(t||I)}}static{this.\u0275mod=o.\u0275\u0275defineNgModule({type:I})}static{this.\u0275inj=o.\u0275\u0275defineInjector({providers:[h.DATA_SERVICE_URI_PROVIDER,{provide:u,useFactory:(e,t,r)=>new f(e,t,r),deps:[[new o.Optional,n.SysSettingsService],E.HttpClient,h.DATA_SERVICE_URI]}]})}}}}]);
