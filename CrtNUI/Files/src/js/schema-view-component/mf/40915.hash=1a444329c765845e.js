(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[40915,63296],{63296:(M,v,c)=>{c.r(v),c.d(v,{CopilotIntentSchemaDesignerApiModule:()=>S});var D=c(5960),C=c(40297),n=c(59131),g=c(38495),p=c(5114),u=c(21018),A=c(95868),f=c(85638),U=c(35266),s=c(62278);class N extends p.BaseSchema{}class z extends p.MetaItem{constructor(){super(...arguments),this.caption=new u.LocalizableStringArray}}class L{constructor(){this.caption=new u.LocalizableStringArray,this.description=new u.LocalizableStringArray}}class l extends p.BaseSchemaConverterService{constructor(t,e){super(N),this._userInfo=t,this._resourceFinderService=e,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(t,e){return e.actions?.map(i=>({Id:i.uid,Code:i.name,Intent:{value:t},ActionType:i.actionSchemaTypeUId,Name:this._resourceFinderService.findLocalizableValue(i.caption),Description:this._resourceFinderService.findLocalizableValue(i.description),Params:i.params,PackageUId:e.package.uId}))}_convertSchemaParametersToDto(t,e,i){return e.map(d=>({UId:d.uId,Intent:{value:t},Name:this._resourceFinderService.findLocalizableValue(d.caption),Code:d.name,Description:d.description,SourceCollection:i,DataValueTypeUId:d.dataValueTypeUId}))}_convertDtoActionToSchema(t,e){const i=t.actions||[],P=e.filter(a=>i.every(r=>r.uid!==a.Id)).map(a=>{const r=new L;return r.uid=a.Id,r.name=a.Code,r.params=a.Params,r.actionSchemaTypeUId=a.ActionType,r.caption.setValueLocalizableString(this._sysCultureName,a.Name),r.description.setValueLocalizableString(this._sysCultureName,a.Description),r}),_=i.filter(a=>e.some(r=>r.Id===a.uid)).map(a=>{const r=e.find(o=>o.Id===a.uid);return a.name=r.Code,a.caption.setValueLocalizableString(this._sysCultureName,r.Name),a.description.setValueLocalizableString(this._sysCultureName,r.Description),a.params=r.Params,a.actionSchemaTypeUId=r.ActionType,a});t.actions=[...P,..._]}_convertDtoParametersToSchema(t,e,i){const d=t[e]||[],T=i.filter(r=>d.every(o=>o.uId!==r.UId)).map(r=>{const o=new z;return o.uId=r.UId,o.name=r.Code,o.caption.setValueLocalizableString(this._sysCultureName,r.Name),o.description=r.Description,o.dataValueTypeUId=r.DataValueTypeUId,o}),a=d.filter(r=>i.some(o=>o.UId===r.uId)).map(r=>{const o=i.find(w=>w.UId===r.uId);return r.name=o.Code,r.caption.setValueLocalizableString(this._sysCultureName,o.Name),r.description=o.Description,r.dataValueTypeUId=o.DataValueTypeUId,r});t[e]=[...T,...a]}_mapActions(t){return t?.map(e=>(e.description=new u.LocalizableStringArray(e.description),e.caption=new u.LocalizableStringArray(e.caption),e))}_mapParameters(t){return t?.map(e=>(e.caption=new u.LocalizableStringArray(e.caption),e))}createSchema(t){const e=super.createSchema(t);return e.caption=new u.LocalizableStringArray(t.caption),e.description=new u.LocalizableStringArray(t.description),e.actions=this._mapActions(t.actions),e.inputParameters=this._mapParameters(t.inputParameters),e.outputParameters=this._mapParameters(t.outputParameters),e}convertToSchema(t){return this.createSchema(t)}mapModelToSchema(t,e){return t.prompt=e.Prompt,t.intentDescription=e.Description,t.caption.setValueLocalizableString(this._sysCultureName,e.Title),t.name=e.Code,t.status=e.Status,t.mode=e.Mode,this._convertDtoParametersToSchema(t,"inputParameters",e.InputParameters??[]),this._convertDtoParametersToSchema(t,"outputParameters",e.OutputParameters??[]),this._convertDtoActionToSchema(t,e.Actions),t}schemaToModel(t,e){return{UId:t,Title:this._resourceFinderService.findLocalizableValue(e.caption),Code:e.name,Description:e.intentDescription||this._resourceFinderService.findLocalizableValue(e.description),Prompt:e.prompt,Status:e.status,Type:e.type,Actions:this._convertSchemaActionToDto(t,e),ExtendParent:e.extendParent,PackageUId:e.package.uId,Mode:e.mode,InputParameters:this._convertSchemaParametersToDto(t,e.inputParameters??[],"InputParameters"),OutputParameters:this._convertSchemaParametersToDto(t,e.outputParameters??[],"OutputParameters")}}static{this.\u0275fac=function(e){return new(e||l)(n.\u0275\u0275inject(u.UserInfo),n.\u0275\u0275inject(u.ResourceFinderService))}}static{this.\u0275prov=n.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac})}}class m extends p.BaseDesignerApiService{constructor(t){super(t)}static{this.\u0275fac=function(e){return new(e||m)(n.\u0275\u0275inject(n.Injector))}}static{this.\u0275prov=n.\u0275\u0275defineInjectable({token:m,factory:m.\u0275fac})}}class h extends f.BaseCachedService{constructor(){super(),this._apiService=(0,n.inject)(m),this._convertor=(0,n.inject)(l),this._currentPackageService=(0,n.inject)(p.CurrentPackageApiService),this._serverClientOperationNotificationReceiver=(0,n.inject)(f.ServerClientOperationNotificationReceiver),this._queryExecutor=(0,n.inject)(U.QueryExecutor),this._copilotIntentChangedSubscribe()}_copilotIntentChangedSubscribe(){this._serverClientOperationNotificationReceiver.getNotifications("CopilotIntentChanged").subscribe(t=>this.setToCache(t.intentUId,this._getIntentSchema(t.intentUId)))}_normalizeUId(t){return t.toLocaleLowerCase()}_getIntentSchema(t){return this._apiService.getSchema({schemaUId:t,useFullHierarchy:!0}).pipe((0,s.map)(e=>{if(!e.success)throw new Error(e.errorInfo?.message||`Failed to get schema with UId: ${t}`);return e.schema}),(0,s.shareReplay)({bufferSize:1,refCount:!1}),(0,s.catchError)(e=>(0,s.throwError)(()=>e)))}setToCache(t,e){super.setToCache(this._normalizeUId(t),e)}getFromCache(t){return super.getFromCache(this._normalizeUId(t))}deleteFromCache(t){return super.deleteFromCache(this._normalizeUId(t))}get(t){let e=this.getFromCache(t);return e||(e=this._getIntentSchema(t),this.setToCache(t,e)),e.pipe((0,s.map)(i=>this._convertor.schemaToModel(t,i)))}getAllCodes(){const t=new g.EntitySchemaQuery("CopilotIntent");return t.addSchemaColumn("Code"),this._queryExecutor.executeSelectQuery(t).pipe((0,s.map)(e=>e.map(i=>String(i.Code))))}update(t){return this.getFromCache(t.UId).pipe((0,s.map)(e=>this._convertor.mapModelToSchema(e,t)),(0,s.switchMap)(e=>this._apiService.saveSchema(e)),(0,s.tap)(e=>{e.success||this.deleteFromCache(t.UId)}))}create(t){return this._currentPackageService.getDesignPackageUId(null).pipe((0,s.switchMap)(e=>this._apiService.createSchema({packageUId:e.uId,extendParent:!1,schemaUId:t})),(0,s.map)(e=>e.schema),(0,s.tap)(e=>this.setToCache(t,(0,s.of)(e))),(0,s.map)(e=>this._convertor.schemaToModel(t,e)))}static{this.\u0275fac=function(e){return new(e||h)}}static{this.\u0275prov=n.\u0275\u0275defineInjectable({token:h,factory:h.\u0275fac})}}let S=class I{static{this.\u0275fac=function(e){return new(e||I)}}static{this.\u0275mod=n.\u0275\u0275defineNgModule({type:I})}static{this.\u0275inj=n.\u0275\u0275defineInjector({providers:[{provide:A.COPILOT_INTENT_REPOSITORY_TOKEN,useClass:h},{provide:m,useFactory:t=>{const e=n.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:t,providers:[(0,p.getSchemaDesignerApiUrlProvider)("CopilotIntentSchemaDesignerService.svc"),{provide:p.SCHEMA_DESIGNER_CONVERTER,useClass:l,deps:[u.UserInfo]},{provide:p.OPTIONS_SKIP_UNSUCCESSFUL_RESPONSE_HANDLING,useValue:!0}]});return new m(e)},deps:[n.Injector]},l],imports:[C.CommonModule,p.SchemaDesignerApiModule]})}};S=(0,D.__decorate)([(0,g.CrtModule)({})],S),function(){(typeof ngJitMode>"u"||ngJitMode)&&n.\u0275\u0275setNgModuleScope(S,{imports:[C.CommonModule,p.SchemaDesignerApiModule]})}()}}]);
