(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[17268],{17268:(M,k,l)=>{l.r(k),l.d(k,{AddonInfo:()=>f,AddonSchema:()=>g,BaseDesignItem:()=>x,BaseSchema:()=>S,BaseSchemaParameter:()=>y,ClientUnitSchema:()=>_,ImageListSchemaItem:()=>b,Message:()=>N,MessageDirection:()=>V,MessageMode:()=>C,MetaItem:()=>o,MetaItemArray:()=>h,Package:()=>I,PackageType:()=>U,SchemaLocalizableStringModel:()=>P,SchemaParameter:()=>m});var z=l(38495),v=l(20442),i=l(21018),L=l(62278),u=l(36486);class g extends i.BaseSchema{constructor(e){super(e),this.typeName="Terrasoft.Core.Addons.AddonSchema",this.metaData=e.metaData,this.addonName=e.addonName,this.targetSchemaUId=e.targetSchemaUId,this.targetSchemaManagerName=e.targetSchemaManagerName,this.typeName=e.typeName,this.id=e.id,this.parentSchemaUId=e.parentSchemaUId,this.package=e.package,this.resources=e.resources,this.useFullHierarchy=e.useFullHierarchy}clone(){return new g(this)}set addonConfig(e){this.metaData=JSON.stringify(e,null,"	")}get addonConfig(){try{return JSON.parse(this.metaData)}catch{throw new Error("Invalid addon JSON metadata received from server")}}equal(e){return this.metaData===e.metaData&&this.addonName===e.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName&&this.targetSchemaUId===e.targetSchemaUId&&this.typeName===e.typeName&&this.extendParent===e.extendParent&&this.uId===e.uId&&this.name===e.name&&this.packageUId===e.packageUId&&this.caption===e.caption&&this.id===e.id&&this.parentSchemaUId===e.parentSchemaUId}}class f{constructor(...e){if(this._isLoaded=!1,this._isChanged=!1,this.id=(0,z.generateGuid)(),e[0]instanceof f){const t=e[0];this.addonName=t.addonName,this._targetSchemaUId=t.targetSchemaUId,this.targetSchemaManagerName=t.targetSchemaManagerName,this.targetParentSchemaUId=t.targetParentSchemaUId,this.targetPackageUId=t.targetPackageUId,this.id=t.id,this._apiService=t._apiService,this._isLoaded=t._isLoaded,this._isChanged=t._isChanged,t._schema&&(this._schema=t._schema.clone()),this.useFullHierarchy=t.useFullHierarchy}else this.addonName=e[0],this._targetSchemaUId=e[1],this.targetParentSchemaUId=e[2],this.targetPackageUId=e[3],this.targetSchemaManagerName=e[4],this._apiService=e[5],this.useFullHierarchy=e[6]}get schema$(){return this._isLoaded?(0,L.of)(this._schema):this._loadSchema()}get isChanged(){return this._isChanged}get resources(){return this._resources}get targetSchemaUId(){return this._targetSchemaUId}set targetSchemaUId(e){this._targetSchemaUId=e,this._schema&&(this._schema.targetSchemaUId=e)}get addonConfig(){return this.schema$.pipe((0,u.map)(e=>{const t=e.addonConfig;return this._setMetadataDefValues(t),t}))}set addonConfig(e){(0,L.forkJoin)([this.schema$,e]).subscribe(([t,a])=>{t.addonConfig=a,this._isChanged=!0})}_setMetadataDefValues(e){this.addonName===i.AddonName.BusinessRule&&e.rules?.forEach(a=>{a.name=a.name||(0,v.generateBusinessRuleName)(),a.enabled=a.enabled||a.enabled===void 0})}_setAddonResources(e){this._resources=e.map(t=>{const a=t.key.split(".");return{key:[a[2],a[3]].join("."),value:t.value}}),this._schema.resources=[...this._resources]}_loadSchema(){return this._schema$?this._schema$:(this._schema$=this._apiService.getAddon({targetSchemaUId:this.targetSchemaUId,addonName:this.addonName,targetParentSchemaUId:this.targetParentSchemaUId,targetPackageUId:this.targetPackageUId,targetSchemaManagerName:this.targetSchemaManagerName,useFullHierarchy:this.useFullHierarchy}).pipe((0,u.tap)(e=>{e.success&&(this._schema=new g(e.schema),this._schema.typeName="Terrasoft.Core.Addons.AddonSchema",this._isLoaded=!0,this._setAddonResources(e.schema.resources??[]))}),(0,u.map)(()=>this._schema),(0,u.share)()),this._schema$)}save(){return this._isLoaded?this._apiService.saveAddon(this._schema).pipe((0,u.map)(e=>e.success),(0,u.tap)(()=>{this._isChanged=!1})):(0,L.of)(!0)}clone(){return new f(this)}equal(e){let t=this._isLoaded===e._isLoaded&&e.targetSchemaUId===this.targetSchemaUId&&e.addonName===this.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName;return t&&this._isLoaded&&(t=this._schema.equal(e._schema)),t}createOrUpdateResource(e){const t=this.resources.findIndex(a=>a.key===e.key);t===-1?this.resources.push(e):this.resources.splice(t,1,e),this._schema.resources=[...this._resources]}removeResource(e){const t=this.resources.findIndex(a=>a.key===e);this.resources.splice(t,1),this._schema.resources=[...this._resources]}}class o{constructor(e){e&&(this.uId=e.uId,this.name=e.name,this.parentSchemaUId=e.parentSchemaUId),this.uId=this.uId||(0,z.generateGuid)()}update(e){this.uId=e.uId,this.name=e.name}equal(e){if(e==null)return!1;let t=this.uId===e.uId&&this.name===e.name;return(this.parentSchemaUId||e.parentSchemaUId)&&(t=t&&this.parentSchemaUId===e.parentSchemaUId),t}clone(){return new o(this)}getLocalizableValues(e){}loadLocalizableValues(e,t=!1){}}class I{constructor(e,t){this.name=e,this.uId=t}equal(e){return e==null?!1:this.uId===e.uId&&this.name===e.name&&this.type===e.type&&this.isChanged===e.isChanged&&this.isLocked===e.isLocked}clone(){const e=new I(this.name,this.uId);return e.type=this.type,e.isChanged=this.isChanged,e.isLocked=this.isLocked,e}}class x extends o{constructor(e){if(super(e),this.isReadOnly=!1,this.useFullHierarchy=!1,this.addonTypes=[],this.addons=[],e){if(this.id=e.id,e.package){const t=e.package;t.clone?this.package=t.clone():(this.package=new I(t.name,t.uId),this.package.type=t.type,this.package.isChanged=t.isChanged,this.package.isLocked=t.isLocked)}if(this.body=e.body,this.isReadOnly=e.isReadOnly,this.useFullHierarchy=e.useFullHierarchy,this.parentSchema=e.parentSchema,this.extendParent=e.extendParent,e.dependencies){const t=e.dependencies;let a=t.requiredSchemas;a&&(a=[...a]);let s=t.requiredEntityColumns;s&&(s=s.map(n=>({entitySchemaName:n.entitySchemaName,columnPaths:[...n.columnPaths]}))),this.dependencies={requiredSchemas:a,requiredEntityColumns:s}}}}updateDescription(e){super.update(e),this.id=e.id,this.package=e.package}equal(e){if(e==null)return!1;let t=super.equal(e)&&this.id===e.id&&this.body===e.body&&this.isReadOnly===e.isReadOnly&&this.useFullHierarchy===e.useFullHierarchy;return(this.package||e.package)&&(t=t&&this.package?.equal(e.package)),t}getLocalizableValues(e){super.getLocalizableValues(e)}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t)}}class h extends Array{constructor(e){super(),e&&Array.isArray(e)&&(this.push(...e.map(t=>t.clone())),this.uId=e.uId),this.uId=this.uId||(0,z.generateGuid)()}deleteItemByUId(e){const t=this.findItemIndex(e);return t<0?!1:(this.splice(t,1),!0)}findItemIndex(e){return this.findIndex(t=>t.uId===e)}findItem(e){return this.find(t=>t.uId===e)}addItem(e){this.unshift(e)}reloadAll(e){this.splice(0,this.length,...e||[])}equal(e){return e==null||this.length!==e?.length?!1:this.every(t=>{const a=e?.findItem(t.uId);return t.equal(a)})}clone(){return new h(this)}getLocalizableValues(e,t){this.forEach(a=>{const s={};a.getLocalizableValues(s),Object.entries(s).forEach(([n,d])=>{e[`${t}.${a.name}.${n}`]=d})})}loadLocalizableValues(e,t,a=!1){const s={};Object.entries(e).map(([n,d])=>{const c=n.split("."),p=c.shift(),E=c.shift(),R=c.join(".");return{itemGroupName:p,itemName:E,itemResourceName:R,values:d}}).filter(({itemGroupName:n})=>n===t).forEach(({itemName:n,itemResourceName:d,values:c})=>{const p=s[n]??{};p[d]=c,s[n]=p}),Object.entries(s).forEach(([n,d])=>{this.find(p=>p.name===n).loadLocalizableValues(d,a)})}}class S extends x{constructor(e){super(e),this.caption=new i.LocalizableStringArray,this.localizableStrings=new h,this.description=new i.LocalizableStringArray,e&&(this.caption=e.caption?e.caption.clone():e.caption,this.description=e.description?e.description.clone():e.description,this.localizableStrings=e.localizableStrings?e.localizableStrings.clone():e.localizableStrings)}get DefaultName(){return"BaseSchema"}findChildrenItem(e){return this.localizableStrings.findItem(e)}findGroup(e){return this.localizableStrings.uId===e?this.localizableStrings:null}updateDescription(e){super.updateDescription(e),this.caption=new i.LocalizableStringArray(e.caption),this.description=new i.LocalizableStringArray(e.description)}equal(e){return e==null?!1:super.equal(e)&&(0,i.areLocalizableStringsEqual)(this.caption,e.caption,!0)&&(0,i.areLocalizableStringsEqual)(this.description,e.description,!0)}clone(){return new S(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),e.description=this.description.clone(),this.localizableStrings.getLocalizableValues(e,"localizableStrings")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.description.setValues(e.description,t),this.localizableStrings.loadLocalizableValues(e,"localizableStrings",t)}getIsOwnMetaItem(e){return this.uId===e.parentSchemaUId}}class P extends o{constructor(e){super(e),this.values=new i.LocalizableStringArray(e?.values)}clone(){return new P(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.values=this.values.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.values.setValues(e.values,t)}}class m extends o{constructor(e){super(e),e&&(this.caption=new i.LocalizableStringArray(e.caption),this.type=e.type,this.lookup=e.lookup,this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value,this.itemProperties=this._mapItemArray(e.itemProperties))}static updateLookupValue(e,t,a){const s=e[a]?e[a].key:null;s?t[a]=s:delete t[a]}_getSourceType(e){return e.type?.key}_mapItemArray(e){return e?new h(e.map(t=>new m(t))):new h}_resetItemProperties(e){this.type!==e&&(this.itemProperties=new h,this.itemProperties.uId=this.uId)}updateDescription(e){this.caption=e.caption,this.name=e.name;const t=this._getSourceType(e);this._resetItemProperties(t),this.type=t,m.updateLookupValue(e,this,"lookup"),this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value}clone(){return new m(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),this.itemProperties.getLocalizableValues(e,"itemProperties")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.itemProperties.loadLocalizableValues(e,"itemProperties",t)}}class y extends S{constructor(e){super(e),this.parameters=new h,e&&(this.parameters=e.parameters.clone())}_findNestedProperties(e,t){const a=t.find(s=>s.uId===e);return a?a.itemProperties:null}_getNestedParametersGroup(e,t){return(0,i.findCollectionRecursive)(t,a=>this._findNestedProperties(e,a),a=>a.itemProperties)}_getParametersGroup(e,t){let a=this._getNestedParametersGroup(e,t);return a||(a=this.parameters.uId===e?this.parameters:null),a}_getParameter(e,t){return(0,i.findItemRecursive)(t,a=>a.uId===e,a=>a.itemProperties)}findChildrenItem(e){return this._getParameter(e,this.parameters)||super.findChildrenItem(e)}findGroup(e){const t=this._getParametersGroup(e,this.parameters);return t||super.findGroup(e)}findNestedParametersGroup(e){return this._getNestedParametersGroup(e,this.parameters)||this.parameters}findParameterByUId(e){return this._getParameter(e,this.parameters)}clone(){return new y(this)}getLocalizableValues(e){super.getLocalizableValues(e),this.parameters.getLocalizableValues(e,"parameters")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.parameters.loadLocalizableValues(e,"parameters",t)}}var w=l(59131),A=l(28399);class _ extends y{constructor(e){super(e),this._markerCommentsTemplate="(\\/\\*\\*PROPERTY_NAME\\*\\/)([\\s\\S]*)(\\/\\*\\*PROPERTY_NAME\\*\\/)",this.messages=new h,this.images=new h,this.onMetaItemsChanged=new w.EventEmitter,this.useFullHierarchy=!1,e&&(this.group=e.group,this.schemaType=e.schemaType,this.schemaVersion=e.schemaVersion,this.parent=(0,A.cloneDeep)(e.parent),this.less=e.less,this.extendParent=e.extendParent,e.messages&&(this.messages=e.messages.clone()),e.images&&(this.images=e.images.clone()),e.addons&&e.addons.length>0&&(this.addons=e.addons),e.addonTypes&&e.addonTypes.length>0&&(this.addonTypes=[...e.addonTypes]),this.useFullHierarchy=e.useFullHierarchy)}get isModule(){return this.schemaType===i.ClientUnitSchemaType.Module}get DefaultName(){return"ClientUnitSchema"}_setNameFromParent(){this.extendParent&&(this.name=this.parent.name)}_addUpdateImages(e){this.images.filter(a=>a.isChanged).forEach(a=>{e.images.find(n=>n.uId===a.uId).updateFile(a.data)})}_fixBodyTabs(e){return e.split(`
`).map((t,a)=>(a>0?"		":"")+t,this).join(`
`)}_getMarkerCommentsRegExp(e){return new RegExp(this._markerCommentsTemplate.replace(/PROPERTY_NAME/g,e))}updateBodySchemaName(e,t){e?.length&&(this.body=this.body?.replace(e,t))}findChildrenItem(e){return this.messages.findItem(e)||this.images.findItem(e)||super.findChildrenItem(e)}findGroup(e){return[this.messages,this.images].find(a=>a.uId===e)||super.findGroup(e)}updateDescription(e){super.updateDescription(e),this._setNameFromParent()}updateMetaItems(e){this._addUpdateImages(e),this.name=e.name,this.parent=e.parent,this.group=e.group,this.caption=new i.LocalizableStringArray(e.caption),this.description=new i.LocalizableStringArray(e.description),this.localizableStrings=new h(e.localizableStrings),this.messages=new h(e.messages),this.images=new h(e.images),this.parameters=new h(e.parameters),this.onMetaItemsChanged.emit()}getSchemaBodyProperty(e){const t=this._getMarkerCommentsRegExp(e),a=this.body.match(t);return a&&a[2]}setSchemaBodyProperty(e,t){let a=JSON.stringify(t||{},null,"	");a=this._fixBodyTabs(a),this.setSchemaBody(e,a)}setSchemaBody(e,t){const a=this._getMarkerCommentsRegExp(e);this.body=this.body.replace(a,"$1"+t+"$3")}clone(){return new _(this)}}class b extends o{constructor(e){super(e),this.isChanged=!1,e&&(this._data=e.data||{},this.image=e.image,this.caption=new i.LocalizableStringArray(e.caption)),this.caption||(this.caption=new i.LocalizableStringArray)}get data(){return this._data}get image(){return this.data?.name}set image(e){!e||e===this.data?.name||Object.assign(this._data,{name:e})}static _getIsFileChanged(e,t){const a=e?.name,s=t?.name,n=a&&!s,d=s&&!a,c=s&&a&&t.size>0;return d||n||c}updateFile(e){this.isChanged=b._getIsFileChanged(this.data,e),this._data=e}clone(){return new b(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t)}}class N extends o{constructor(e){super(e),e&&(this.direction=e.direction,this.mode=e.mode)}clone(){return new N(this)}}var V;(function(r){r[r.Subscribe=0]="Subscribe",r[r.Publish=1]="Publish"})(V||(V={}));var C;(function(r){r[r.Broadcast=0]="Broadcast",r[r.PointToPoint=1]="PointToPoint"})(C||(C={}));var U;(function(r){r[r.General=0]="General",r[r.Assembly=1]="Assembly"})(U||(U={}))}}]);
