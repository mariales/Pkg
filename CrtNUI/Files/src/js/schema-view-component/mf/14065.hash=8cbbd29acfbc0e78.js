(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[14065],{14065:(w,I,d)=>{d.r(I),d.d(I,{BaseRelatedInMainRecordsHandler:()=>F,BaseRelatedInMainRecordsService:()=>P,OpenBaseSelectSelectionWindowHandler:()=>_,OpenBaseSelectSelectionWindowRequest:()=>y,OpenSelectionWindowRequest:()=>v,PAGE_LOOKUP_DATA_TOKEN:()=>M,PAGE_LOOKUP_RESULT_TYPE_DEFAULT_VALUE:()=>x,PageLookupResultType:()=>R,RelatedRecordsActionsEnum:()=>p,SelectionApiMode:()=>S,SelectionWindowResult:()=>V});var k=d(63721),g=d(59131),a=d(38495),N=d(79772),E=d(21018),m=d(28399),h=d(62278),p;(function(o){o[o.AddRelatedRecords=0]="AddRelatedRecords",o[o.RemoveRelatedRecords=1]="RemoveRelatedRecords"})(p||(p={}));class P{constructor(){this._translateService=(0,g.inject)(N.TranslateService),this._httpClient=(0,g.inject)(k.HttpClient),this._userInfo=(0,g.inject)(E.UserInfo)}get _relatedInMainRecordsServiceEndpoint(){return(this._userInfo.isSSP?"ssp/":"")+`rest/${this.relatedInMainRecordsServiceName}/`}_isInvalidParameters(e){return(0,m.isEmpty)(e.relatedRecordsSchemaName)||(0,m.isEmpty)(e.relatedInMainRecordsSchemaName)||(0,m.isEmpty)(e.relatedRecordColumnName)||(0,m.isEmpty)(e.mainRecordColumnName)||!this._isValidFilters(e.relatedRecordsFilters)||!this._isValidFilters(e.mainRecordsFilters)}_isValidFilters(e){return(0,m.isObject)(e)&&"items"in e&&!(0,m.isEmpty)(e.items)}_catchHttpErrorResponse(e){return(0,h.of)({success:!1,message:e.error?.errorInfo?.message??e.message})}_createEsqWithFilters(e,t){const s=new a.EntitySchemaQuery(e);return this._addFiltersToEsq(s,t),s}_addFiltersToEsq(e,t){Object.entries(t.items).forEach(([s,i])=>{e.filters.add(i,s)})}getServiceResultMessage(e,t,s){if(e.success){const i=this.relatedRecordsActionsNames.get(t);return this._translateService.instant(`${this.relatedInMainRecordsServiceName}.ServiceResult.${i}${s}`,{count:(0,m.get)(e,"processedRecordsCount",null)})}return e.errorInfo?.message||this._translateService.instant("BaseRelatedInMainRecordsService.ServiceResult.ErrorMessage")}executeAction(e,t){return this._isInvalidParameters(t)?(0,h.of)({success:!1,message:this._translateService.instant("BaseRelatedInMainRecordsService.NotValidParametersMessage")}):this.process(e,t)}process(e,t){const s=this.createRelatedRecordsEsq(t),i=this.createMainRecordsEsq(t),r=this.createRequest(s,i,t);return this.callService(e,r,t)}createRelatedRecordsEsq(e){return this._createEsqWithFilters(e.relatedRecordsSchemaName,e.relatedRecordsFilters)}createMainRecordsEsq(e){return this._createEsqWithFilters(e.mainRecordsSchemaName,e.mainRecordsFilters)}callService(e,t,s){const i=this.relatedRecordsActionsNames.get(e);return this._httpClient.post(`${this._relatedInMainRecordsServiceEndpoint}${i}`,{request:t}).pipe((0,h.map)(r=>({success:r.success,message:this.getServiceResultMessage(r,e,"Message")})),(0,h.catchError)(r=>this._catchHttpErrorResponse(r)))}addRelatedRecords(e){return this.executeAction(p.AddRelatedRecords,e)}removeRelatedRecords(e){return this.executeAction(p.RemoveRelatedRecords,e)}}var u=d(73308),L=d(59564),O=d(20822);class F extends a.BaseRequestHandler{constructor(e){super(),this.injector=e,this.notifyService=e.get(L.NotifyService),this.maskService=e.get(a.MaskService),this.messageDialogProvider=e.get(O.MessageDialogProvider)}_getOpenLookupPageRequestConfig(e){return{type:"crt.OpenSelectionWindowRequest",$context:e.$context,scopes:e.scopes,features:this.getLookupPageFeatures(),entitySchemaName:this.getLookupPageEntitySchemaName(e),caption:this.getLookupPageCaption(e),filtersConfig:this._getLookupPageFiltersConfig(e),afterClosed:s=>this._afterClosedLookupPageAction(e,s)}}_getLookupPageFiltersConfig(e){const t=this.getLookupPageFilter(e);if(!t)return;const s="lookup_page_filter";return{filterAttributes:[{name:s,loadOnChange:!1}],attributesConfig:{[s]:{value:t}}}}_afterClosedLookupPageAction(e,t){t.canceled||(this.maskService.showMask(this.getMaskTaskName(e),e.$context),this.runServiceAction(e,t.filter).pipe((0,h.tap)(()=>{this.maskService.hideMask(this.getMaskTaskName(e),e.$context)})).subscribe(s=>{this._processServiceResult(e,s)}))}_processServiceResult(e,t){const s={message:t.message};if(t.success){this.showSuccessNotification(e,s);return}this.notifyService.error(s)}_validateRequest(e){return this._validateRequestDataSource(e)&&this._validateRequestFilters(e)}_validateRequestDataSource(e){return e.dataSourceName?!0:(this.messageDialogProvider.error("InfoDialog.SettingsErrorMessage"),!1)}_validateRequestFilters(e){return this._isValidFilters(e.filters)?!0:(this.notifyService.error({message:this.invalidErrorMessageForSelectRecordsValidator}),!1)}_isValidFilters(e){return(0,m.isObject)(e)&&"items"in e&&!(0,m.isEmpty)(e.items)}getLookupPageFeatures(){return{create:{enabled:!1},select:{multiple:!0,selectAll:!1}}}getLookupPageFilter(e){return null}showSuccessNotification(e,t){this.notifyService.show(t)}getRelatedRecordsSchemaName(e){return e.$context.dataSchemas[e.dataSourceName]?.name}runServiceAction(e,t){const s=this.createServiceData(e,t);return this.openLookupPageMode==="AddRecords"?this.addRecordsServiceAction(s):this.removeRecordsServiceAction(s)}addRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.addRelatedRecords(e)}removeRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.removeRelatedRecords(e)}initializeData(e){}handle(e){var t=this;return(0,u.A)(function*(){if(!t._validateRequest(e))return;yield t.initializeData(e);const s=t._getOpenLookupPageRequestConfig(e);yield t.handlerChain.process(s)})()}}var f=d(5960),R;(function(o){o.LookupValues="lookupValues",o.Filter="filter"})(R||(R={}));const x=R.LookupValues;var S;(function(o){o[o.Legacy=0]="Legacy",o[o.New=1]="New"})(S||(S={}));const M=new g.InjectionToken("PageLookupDataToken");class V{get canceled(){return this._canceled}get filter(){return this._filter}constructor(e){this._cachedLookupValues=[],this._entityName=e?.entityName,this._selectionState=e?.selectionState,this._filter=e?.filter,this._cachedLookupValues=e?.cachedLookupValues??[],this._canceled=e?.canceled??!1}_getFilterByPrimaryValues(e,t){const s=new a.EntitySchemaQuery("tempTable"),i=new a.ColumnExpression({columnPath:e}),r=t.map(c=>new a.ParameterExpression({value:c})),l=new a.InFilter(a.ComparisonType.Equal,i,r);return s.filters.add(l),s.getMetadata().filters}_loadLookupValues(e,t,s,i){return(0,u.A)(function*(){const{primaryAttributeName:r,primaryDisplayAttributeName:l,primaryColorAttributeName:n}=t,c=[r,l,n].filter(Boolean);return(yield e.load({attributes:c,parameters:[{type:a.ModelParameterType.Filter,value:s}],options:i?{pagingConfig:i}:{}})).map(A=>({value:A[r],displayValue:A[l],primaryColorValue:A[n]}))})()}_loadLookupValuesByPrimaryValues(e,t){var s=this;return(0,u.A)(function*(){if(!t.length)return[];const i=yield a.Model.create(e),r=yield i.getSchema(),l=s._getFilterByPrimaryValues(r.primaryAttributeName,t);return s._loadLookupValues(i,r,l)})()}_isCached(e){return this._cachedLookupValues.some(t=>t.value===e)}getLookupValues(e){var t=this;return(0,u.A)(function*(){if(!t._selectionState||t.canceled)return[];const s=e?.pagingConfig;if(t._selectionState?.type==="specific"){let i;(0,m.isUndefined)(s?.rowsOffset)||(0,m.isUndefined)(s?.rowCount)?i=[...t._selectionState.selected]:i=t._selectionState.selected.slice(s?.rowsOffset,s?.rowsOffset+s?.rowCount);const r=i.filter(n=>!t._isCached(n)),l=yield t._loadLookupValuesByPrimaryValues(t._entityName,r);return i.map(n=>t._cachedLookupValues.find(c=>c.value===n)||l.find(c=>c.value===n))}else{const i=yield a.Model.create(t._entityName),r=yield i.getSchema();return t._loadLookupValues(i,r,t._filter,s)}})()}}let v=class extends a.BaseRequest{};v=(0,f.__decorate)([(0,a.CrtRequest)({type:"crt.OpenSelectionWindowRequest"})],v);const C="ItemsFilter";let _=class extends a.BaseRequestHandler{constructor(e){super(),this._maskService=e}_getOpenLookupPageRequestConfig(e){var t=this;return(0,u.A)(function*(){const s=yield t._getSelectedIds(e),i=yield t._getItemsFilter(e),r=t._getIsCreateEnabled(e);return{type:"crt.OpenSelectionWindowRequest",$context:e.$context,scopes:e.scopes,features:{create:{enabled:r},select:{multiple:!0,selectAll:!1,resultType:R.LookupValues}},itemsAttributeName:e.itemsAttributeName,selectionState:{type:"specific",selected:s},filtersConfig:{filterAttributes:[{name:C,loadOnChange:!1}],attributesConfig:{[C]:{value:i}}},afterClosed:l=>t._afterClosedLookupPageAction(e,l)}})()}_getSelectedIds(e){var t=this;return(0,u.A)(function*(){const s=yield t._getSelectedItems(e);return Promise.all(s.map(i=>i.Id))})()}_getSelectedItems(e){return e.$context[e.selectedItemsAttributeName]}_getItemsFilter(e){return e.filterAttributeName?e.$context[e.filterAttributeName]:Promise.resolve(null)}_getIsCreateEnabled(e){return e.enableAddRecord}_afterClosedLookupPageAction(e,t){var s=this;return(0,u.A)(function*(){if(t.canceled)return Promise.resolve();s._maskService.showMask(s._getMaskTaskName(e),e.$context);const i=yield s._getMergeIds(e,t);yield s._runAddRemoveActions(e,i),s._maskService.hideMask(s._getMaskTaskName(e),e.$context)})()}_getMaskTaskName(e){return`OpenSelectionWindow_${e.selectedItemsAttributeName}`}_getMergeIds(e,t){var s=this;return(0,u.A)(function*(){const i=yield s._getSelectedIds(e),r=(yield t.getLookupValues()).map(c=>c.value),l=r.filter(c=>!i.includes(c)),n=i.filter(c=>!r.includes(c));return{idsToAdd:l,idsToRemove:n}})()}_runAddRemoveActions(e,t){var s=this;return(0,u.A)(function*(){yield s._processAddCollectionItemsRequest(e,t.idsToAdd),yield s._processRemoveCollectionItemsRequest(e,t.idsToRemove)})()}_processAddCollectionItemsRequest(e,t){if(!t.length)return Promise.resolve();const s={type:"crt.AddSelectedItemsInRecordManualRequest",$context:e.$context,scopes:e.scopes,collectionAttributeName:e.selectedItemsAttributeName,selectedIds:t,selectColumnName:e.selectColumnName,recordRelationColumnName:e.recordRelationColumnName,recordId:e.recordId};return this.handlerChain.process(s)}_processRemoveCollectionItemsRequest(e,t){var s=this;return(0,u.A)(function*(){if(!t.length)return Promise.resolve();const i=yield s._getRelationRecordIds(e,t),r={type:"crt.RemoveCollectionItemsRequest",$context:e.$context,scopes:e.scopes,collectionAttributeName:e.selectedItemsAttributeName,primaryAttributeValues:i};return s.handlerChain.process(r)})()}_getRelationRecordIds(e,t){var s=this;return(0,u.A)(function*(){const i=yield s._getSelectedItems(e);return(yield Promise.all(i.map(function(){var l=(0,u.A)(function*(n){const c=yield n.Id;if(t.includes(c))return n[n.primaryAttributeName]});return function(n){return l.apply(this,arguments)}}()))).filter(Boolean)})()}handle(e){var t=this;return(0,u.A)(function*(){const s=yield t._getOpenLookupPageRequestConfig(e);yield t.handlerChain.process(s)})()}};_=(0,f.__decorate)([(0,a.CrtRequestHandler)({requestType:"crt.OpenBaseSelectSelectionWindowRequest",type:"crt.OpenBaseSelectSelectionWindowHandler"}),(0,f.__metadata)("design:paramtypes",[a.MaskService])],_);let y=class extends a.BaseRequest{};y=(0,f.__decorate)([(0,a.CrtRequest)({type:"crt.OpenBaseSelectSelectionWindowRequest"})],y)}}]);
