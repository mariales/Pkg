(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[42574,73308,50927,28546,6165,62832,40451,18070,95689,94260,71879,41421,63802,86183,8564,30945,53326,75707,98088,20469,42850,70422,48041,15184,92803,80898,58517,25660,3279,91374,68993,83231,5612,38469],{42574:(cs,re,R)=>{R.r(re),R.d(re,{ApplicabilityType:()=>pe,BUSINESS_RULES_REPOSITORY_INJECTION_TOKEN:()=>xs,BaseBusinessRuleDesignAction:()=>ue,BaseBusinessRuleDesignCondition:()=>v,BaseBusinessRulesManager:()=>es,BusinessRuleAttributeDesignExpression:()=>F,BusinessRuleContextExpression:()=>$e,BusinessRuleDesign:()=>he,BusinessRuleDesignAction:()=>b,BusinessRuleDesignActionFactory:()=>C,BusinessRuleDesignCase:()=>Q,BusinessRuleDesignCondition:()=>Y,BusinessRuleDesignConditionFactory:()=>Ze,BusinessRuleDesignEmptyCondition:()=>G,BusinessRuleDesignExpression:()=>E,BusinessRuleDesignExpressionFactory:()=>S,BusinessRuleDesignTrigger:()=>ee,BusinessRuleEditableElementDesignAction:()=>k,BusinessRuleEmptyValueDesignExpression:()=>ke,BusinessRuleExecutionErrorType:()=>te,BusinessRuleFieldSelectionElementDesignAction:()=>I,BusinessRuleFilterLookupAction:()=>j,BusinessRuleFilterLookupDesignExpression:()=>L,BusinessRuleFilterValueDesignExpression:()=>Ge,BusinessRuleFormulaDesignExpression:()=>je,BusinessRuleFormulaExpressionParameterMapping:()=>se,BusinessRuleGroupDesignCondition:()=>Z,BusinessRuleHideElementDesignAction:()=>O,BusinessRuleOptionalElementDesignAction:()=>$,BusinessRulePropertiesPanelService:()=>ne,BusinessRuleReadOnlyElementDesignAction:()=>q,BusinessRuleRequiredElementDesignAction:()=>W,BusinessRuleSetFilterAction:()=>K,BusinessRuleSetPropertyDesignAction:()=>Je,BusinessRuleSetValueDesignAction:()=>z,BusinessRuleSetValueItem:()=>H,BusinessRuleSetValuesDesignAction:()=>J,BusinessRuleShowElementDesignAction:()=>X,BusinessRuleSysSettingDesignExpression:()=>Fe,BusinessRuleSysValueDesignExpression:()=>Pe,BusinessRuleValueDesignExpression:()=>D,BusinessRulesApplier:()=>U,BusinessRulesConditionExecutor:()=>T,BusinessRulesEngine:()=>P,BusinessRulesFilterLookupActionApplier:()=>Be,BusinessRulesManager:()=>V,BusinessRulesModule:()=>ge,BusinessRulesSetFilterActionApplier:()=>Ne,BusinessRulesSetPropertyActionApplier:()=>ae,BusinessRulesSetReadonlyPropertyActionApplier:()=>_e,BusinessRulesSetRequiredPropertyActionApplier:()=>Me,BusinessRulesSetValueActionApplier:()=>me,BusinessRulesSetVisibilityPropertyActionApplier:()=>be,BusinessRulesTriggerExecutor:()=>w,ScopeStateType:()=>_,ScopeType:()=>A,TestBusinessRuleDesignAction:()=>fe,businessRuleEditableElementTypeName:()=>Xe,businessRuleOptionalElementTypeName:()=>Te,businessRuleReadonlyElementTypeName:()=>Ye,businessRuleRequiredElementTypeName:()=>Ve,canToggleAttribute:()=>ys,generateBusinessRuleName:()=>Qe,isEmptyScope:()=>Ce,isSameScope:()=>le});var d=R(5960),a=R(38495),p=R(21018),l=R(62278),h=R(59131);class x{static{this._actionAppliers=new Map}static register(e,s){x._actionAppliers.set(e,s)}get(e){const s=x._actionAppliers.get(e.typeName);if(!s)throw new Error(`Business rule applier for change type ${e.typeName} not found.`);return new s(e)}static{this.\u0275fac=function(s){return new(s||x)}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:x,factory:x.\u0275fac})}}function B(i){return function(e){(0,a.checkTypeNameFormat)(i.type,"BusinessRulesActionApplierTypeName"),(0,a.checkCrtTypeNamePascalCase)(i.type),x.register(i.type,e)}}var A;(function(i){i.Model="Model",i.ViewModel="ViewModel"})(A||(A={}));var _;(function(i){i.Unknown="Unknown",i.Init="Init",i.Create="Create",i.Copy="Copy",i.Update="Update"})(_||(_={}));class N{constructor(e){this.action=e}_logError(e){return console.error("Error when applying business rule",this.action),console.error(e),(0,l.of)(null)}apply(e,s){let t;try{t=this.innerApply(e,s)}catch(n){return this._logError(n)}return t.pipe((0,l.catchError)(n=>this._logError(n)))}}var f=R(73308);class oe{static _getPrimaryDisplayAttributeName(e){return(0,f.A)(function*(){return(yield e.getSchema()).primaryDisplayAttributeName})()}static getLookupValue(e,s){var t=this;return(0,f.A)(function*(){const n=yield a.Model.create(e),r=yield n.getSchema(),o=[r.primaryAttributeName,r.primaryDisplayAttributeName];r.primaryColorAttributeName&&o.push(r.primaryColorAttributeName);const u=yield n.load({parameters:[{type:a.ModelParameterType.PrimaryColumnValue,value:s}],attributes:o});if(!u||u.length===0)throw new Error(`Can't find value for '${s}'`);if(u.length>1)throw new Error(`Load more than 1 data row for '${s}'`);const c=u[0],m=yield t._getPrimaryDisplayAttributeName(n),y={value:s,displayValue:c[m]};return r.primaryColorAttributeName&&(y.primaryColorValue=c[r.primaryColorAttributeName]),y})()}}let me=class extends N{_getValue(e){const s=e.value,t=s.value;if(t==null)return(0,l.of)(t);const n=s.dataValueTypeName,o=Object.values(p.DataValueTypeItems).find(c=>c.name===n)?.type??a.DataValueType.Text,u=(0,p.parseJsonValue)(t,o);return o===a.DataValueType.Lookup?(0,l.from)(oe.getLookupValue(s.referenceSchemaName,s.value)):(0,l.of)(u)}_setValue(e,s,t){const n=this.action.path,r=e.getViewModelAttributePath(s,n);return r?e.setValue({[r]:t}):e.setModelValues(s,{[n]:t})}innerApply(e,s){const t=this.action,n=t.value;return t.skip===!0?(0,l.of)(null):this._getValue(t).pipe((0,l.switchMap)(r=>{if(s.type===A.Model)return this._setValue(e,s.id,r);if(n.scope)return this._setValue(e,n.scope,r);const o=e.getAttributeNameByViewItemName(t.path);return o?e.setValue({[o]:r}):e.setValue({[t.path]:r})}))}};me=(0,d.__decorate)([B({type:"crt.SetValue"})],me);class ae extends N{_getAttributeNames(e,s,t){if(s.type===A.Model)return e.getViewModelAttributePaths(s.id,t);let n=e.getAttributeNameByViewItemName(t);return n||(n=(0,p.generatePropertiesAttributeName)(t)),[n]}setAttributePropertyValue(e,s,t){e.setAttributePropertyValue(s,this.propertyName,t)}resetAttributePropertyValue(e,s){e.resetAttributePropertyValue(s,this.propertyName)}innerApply(e,s){const t=this.action.path;if(!t)return(0,l.of)(!0);const r=t.split(":")[0],o=this._getAttributeNames(e,s,r);return o&&o.forEach(u=>{this.action.resetToDefault?this.resetAttributePropertyValue(e,u):this.setAttributePropertyValue(e,u,this.action.value)}),(0,l.of)(!0)}}function He(i,e){return ye.apply(this,arguments)}function ye(){return ye=(0,f.A)(function*(i,e){let s=yield i[e];return s instanceof a.FilterGroup||(s=new a.FilterGroup,i[e]=s),s}),ye.apply(this,arguments)}function hs(i,e,s){return Re.apply(this,arguments)}function Re(){return Re=(0,f.A)(function*(i,e,s){return(yield He(i,e)).filters.get(s)||new a.FilterGroup(a.LogicalOperatorType.And)}),Re.apply(this,arguments)}function ds(i,e,s,t){return xe.apply(this,arguments)}function xe(){return xe=(0,f.A)(function*(i,e,s,t){const n=yield He(i,e);n.add(t,s),i[e]=n}),xe.apply(this,arguments)}function gs(i,e,s){return i.getViewModelAttributePaths(e,s).map(r=>(0,p.getItemsAttributeName)(r)).map(r=>(0,p.getBusinessRuleFilterAttributeName)(r))}function Ae(i,e,s,t,n,r){return Ee.apply(this,arguments)}function Ee(){return Ee=(0,f.A)(function*(i,e,s,t,n,r){const o=gs(i,e,s);for(const u of o){const c=yield hs(i,u,n);c.add(t,r),yield ds(i,u,n,c)}}),Ee.apply(this,arguments)}let Be=class extends N{_createLookupFilterGroup(e,s){const t=new a.FilterGroup(a.LogicalOperatorType.And),n=new a.CompareFilter(a.ComparisonType.Equal,new a.ColumnExpression({columnPath:e}),new a.ParameterExpression({value:s}));return t.add(n,"lookupFilter"),t}_setFilterForScope(e,s){const t=this.action,n=t.path;if(t.value){const{leftExpression:r,rightExpression:o}=t.value,u=this._createLookupFilterGroup(r,o.value);return Ae(e,s,n,u,t.businessRuleUId,t.actionUId)}return Ae(e,s,n,new a.FilterGroup,t.businessRuleUId,t.actionUId)}innerApply(e,s){const t=this._setFilterForScope(e,s.id);return(0,l.from)(t)}};Be=(0,d.__decorate)([B({type:"crt.FilterLookup"})],Be);let Ne=class extends N{_getFilter(e){if(e){const s=e.value,t=JSON.parse(s);return a.FilterParser.fromJson(t)}else return new a.FilterGroup}innerApply(e,s){const t=this.action,n=this._getFilter(t.value),r=Ae(e,s.id,t.path,n,t.businessRuleUId,t.actionUId);return(0,l.from)(r)}};Ne=(0,d.__decorate)([B({type:"crt.SetFilter"})],Ne);let be=class extends ae{constructor(){super(...arguments),this.propertyName="visible"}};be=(0,d.__decorate)([B({type:"crt.SetVisibilityPropertyActionApplier"})],be);let _e=class extends ae{constructor(){super(...arguments),this.propertyName="readonly"}_getPropertyName(e,s){return e.getInvariabilityPropertyName(s)??this.propertyName}setAttributePropertyValue(e,s,t){const n=this._getPropertyName(e,s);e.setAttributePropertyValue(s,n,t)}resetAttributePropertyValue(e,s){const t=this._getPropertyName(e,s);e.resetAttributePropertyValue(s,t)}};_e=(0,d.__decorate)([B({type:"crt.SetReadonlyPropertyActionApplier"})],_e);let Me=class extends ae{constructor(){super(...arguments),this.propertyName="required"}};Me=(0,d.__decorate)([B({type:"crt.SetRequiredPropertyActionApplier"})],Me);class v{constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BaseBusinessRuleDesignCondition",e?this.uId=e?.uId:this.uId=(0,a.generateGuid)()}toMetadata(){return{typeName:this.typeName,uId:this.uId}}copy(){return new v({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return!!this.uId}onDataSourceAttributeNameChanged(e,s,t){}isAttributeUsed(e,s){return!1}getWarningMessages(){return[]}}class G extends v{}class ue{constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleAction",this.enabled=!0,this.uId=e?.uId||(0,a.generateGuid)(),e&&(this.enabled=e.enabled)}toMetadata(){return{typeName:this.typeName,uId:this.uId,enabled:this.enabled}}getTypeName(){return this.typeName}getApplicability(){return[]}isValid(){return!0}onDataSourceAttributeNameChanged(e,s,t){}isAttributeUsed(e,s){return!1}getAffectedItems(){return[]}getRequiredItems(){return[]}}class E{get dataValueTypeName(){return this._dataValueTypeName}set dataValueTypeName(e){this._dataValueTypeName=e}get isLookup(){return this.dataValueTypeName===p.DataValueTypeItems[a.DataValueType.Lookup].name}get referenceSchemaName(){return this._referenceSchemaName}set referenceSchemaName(e){this._referenceSchemaName!==e&&(this._referenceSchemaName=e)}constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleExpression",this._dataValueTypeName="",this._referenceSchemaName="",this.type=p.BusinessRuleExpressionType.Const,this.uId=e?.uId||(0,a.generateGuid)(),e&&(this._dataValueTypeName=e.dataValueTypeName??"",this.type=e.type||this.type,this._referenceSchemaName=e.referenceSchemaName??"")}toMetadata(){return{typeName:this.typeName,uId:this.uId,type:this.type,dataValueTypeName:this.dataValueTypeName,referenceSchemaName:this.referenceSchemaName}}copy(){return new E({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return!!this.uId}onDataSourceAttributeNameChanged(e,s,t){}getAffectedItem(){return null}clear(){throw new Error(`clear not implemented for BusinessRuleDesignExpression ${this.constructor.name}`)}setValue(e){throw new Error(`setValue not implemented for BusinessRuleDesignExpression ${this.constructor.name}`)}getValue(){throw new Error(`getValue not implemented for BusinessRuleDesignExpression ${this.constructor.name}`)}isEmpty(){throw new Error(`isEmpty not implemented for BusinessRuleDesignExpression ${this.constructor.name}`)}isAttributeUsed(e,s){return!1}}class S{static{this._expressionsTypes=new Map}static register(e,s){this._expressionsTypes.set(e,s)}static _getExpressionType(e){return this._expressionsTypes.get(e)??null}get(e){if(!e)return new E;const s=S._getExpressionType(e.typeName);return s?new s(e):new E(e)}}function fs(i,e){return!!e?.find(t=>!t.scopeId&&t.triggers.find(n=>n.name===i.name))}function ms(i,e){return!!e?.find(t=>t.scopeName===i.scopeName&&t.triggers?.find(n=>n.name===i.name))}function ys(i,e,s){if(e.scopeName===i){if(fs(e,s))return!1}else if(ms(e,s))return!1;return!0}function le(i,e){return i===e||Ce(i)&&Ce(e)}function Ce(i){return!i||i==="null"}function M(i){return function(e){S.register(i.typeName,e)}}var Se;let F=Se=class extends E{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleAttributeExpression",this.path="",this.scopeId="",e&&(this.path=e.path,this.scopeId=e.scopeId==="null"?"":e.scopeId)}toMetadata(){return{...super.toMetadata(),path:this.path,scopeId:this.scopeId}}copy(){return new Se({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return super.isValid()&&!!this.path}onDataSourceAttributeNameChanged(e,s,t){this.scopeId===e&&this.path===s&&(this.path=t)}getAffectedItem(){return{name:this.path}}isAttributeUsed(e,s){return this.path===s&&le(this.scopeId,e)}};F=Se=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleAttributeExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],F);class b extends ue{constructor(e){super(e),this._expressionFactory=new S,this.typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleAction",this.executorName="",e&&(this.executorName=e.executorName,this.expression=new F(e.expression),e.value&&(this.value=this._expressionFactory.get(e.value)))}getExpressionAffectedItems(){const e=this.expression?.getAffectedItem()??null;return e?[e]:[]}toMetadata(){return{...super.toMetadata(),executorName:this.executorName,expression:this.expression?.toMetadata(),value:this.value?.toMetadata()}}clone(){return new b(this.toMetadata())}copy(){const e=new b({...this.toMetadata(),uId:(0,a.generateGuid)()});return e.expression=this.expression?.copy(),e.value=this.value?.copy(),e}getApplicability(){if(!this.expression?.path)return[];const s=this.expression.path.split(".").shift();return s?[{path:s}]:[]}isValid(){return super.isValid()&&!!this.expression?.isValid()&&!!this.value?.isValid()}getAffectedItems(){const e=this.getExpressionAffectedItems();return[...super.getAffectedItems(),...e]}}class Je extends ue{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetProperty"}}class I extends Je{constructor(e){super(e),this.items=[],e&&(Array.isArray(e.items)?this.items=e.items:this.items=e.items?.length>0?e.items.split(","):[])}_getAffectedItems(){return(this.items??[]).map(s=>({name:s}))}toMetadata(){return{...super.toMetadata(),items:this.items?.length>0?this.items.join(","):""}}getApplicability(){return this.isValid()?this.items.map(e=>({path:e})):[]}isValid(){return super.isValid()&&this.items?.length>0}getAffectedItems(){return[...super.getAffectedItems(),...this._getAffectedItems()]}isAttributeUsed(e,s){return this.items.includes(s)}}const Xe="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionEditableElement";class k extends I{constructor(){super(...arguments),this.typeName=Xe}clone(){return new k(this.toMetadata())}copy(){return new k({...this.toMetadata(),uId:(0,a.generateGuid)()})}}var Ie;let L=Ie=class extends E{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterLookupExpression",this.path="",this.filterExpression="",e&&(this.path=e.path,this.filterExpression=e.filterExpression==="null"?"":e.filterExpression)}toMetadata(){return{...super.toMetadata(),path:this.path,filterExpression:this.filterExpression}}copy(){return new Ie({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return super.isValid()&&!!this.path&&!!this.filterExpression}getAffectedItem(){return{name:this.path}}isAttributeUsed(e,s){return this.path===s}};L=Ie=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterLookupExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],L);class j extends b{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionFilterLookup",this.clearValue=!1,this.populateValue=!1,e?(this.clearValue=e.clearValue??!1,this.populateValue=e.populateValue??!1):(this.clearValue=!0,this.populateValue=!0),this._processMetadata(e)}_isOldMetadataFormat(e){const s=!!e.expression?.path&&e.expression.path!=="null",t=e.value,n=!!t?.value&&t.value!=="null";return s&&n}_convertOldMetadata(e){const s={...e},t=e.expression?.path||"",r=e.value?.value,o={path:r,filterExpression:""},u={path:t,filterExpression:""};if(r.includes(".")){const[c,...m]=r.split(".");o.path=c,o.filterExpression=m.join(".")}return{...s,leftExpression:o,rightExpression:u}}_processMetadata(e){e&&(this._isOldMetadataFormat(e)&&(e=this._convertOldMetadata(e)),delete this.expression,delete this.value,this.leftExpression=new L(e?.leftExpression),this.rightExpression=new L(e?.rightExpression))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),clearValue:this.clearValue,populateValue:this.populateValue}}clone(){return new j({...this.toMetadata()})}copy(){return new j({...super.copy().toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),clearValue:this.clearValue,populateValue:this.populateValue})}getApplicability(){return this.leftExpression?.path?[{path:this.leftExpression.path}]:[]}isValid(){return!!this.leftExpression?.isValid()&&!!this.rightExpression?.path}getAffectedItems(){const e=this.leftExpression?.getAffectedItem()??null,s=[...super.getAffectedItems()];return e&&s.push(e),s}getRequiredItems(){return[this.rightExpression?.getAffectedItem()].filter(e=>e)}isAttributeUsed(e,s){return this.leftExpression.isAttributeUsed(e,s)||this.rightExpression.isAttributeUsed(e,s)}}class O extends I{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionHideElement"}clone(){return new O(this.toMetadata())}copy(){return new O({...this.toMetadata(),uId:(0,a.generateGuid)()})}}const Te="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionOptionalElement";class $ extends I{constructor(){super(...arguments),this.typeName=Te}clone(){return new $(this.toMetadata())}copy(){return new $({...this.toMetadata(),uId:(0,a.generateGuid)()})}}const Ye="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionReadonlyElement";class q extends I{constructor(){super(...arguments),this.typeName=Ye}clone(){return new q(this.toMetadata())}copy(){return new q({...this.toMetadata(),uId:(0,a.generateGuid)()})}}const Ve="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionRequiredElement";class W extends I{constructor(){super(...arguments),this.typeName=Ve}clone(){return new W(this.toMetadata())}copy(){return new W({...this.toMetadata(),uId:(0,a.generateGuid)()})}}var we;let D=we=class extends E{get value(){return this._value}set value(e){this._value!==e&&(this._displayValueInitialized=!1,this._value=e)}get referenceSchemaName(){return super.referenceSchemaName}set referenceSchemaName(e){this.referenceSchemaName!==e&&(super.referenceSchemaName=e,this._displayValueInitialized=!1)}get displayValue(){return this.isLookup&&this.referenceSchemaName?this._displayValueInitialized?this._displayValue:null:(this._displayValue=this.value,this._displayValueInitialized=!0,this._displayValue)}set displayValue(e){this._displayValue=e??"",this._displayValueInitialized=e!=null}get dataValueTypeName(){return super.dataValueTypeName}set dataValueTypeName(e){this.dataValueTypeName!==e&&(super.dataValueTypeName=e,this._displayValueInitialized=!1)}constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleValueExpression",this._value="",this._displayValue="",this._displayValueInitialized=!1,e&&(this._value=e.value)}initDisplayValue(){var e=this;return(0,f.A)(function*(){if(e._displayValueInitialized)return Promise.resolve(e._displayValue);if(e.isLookup&&e.referenceSchemaName&&e._value){const s=yield oe.getLookupValue(e.referenceSchemaName,e._value);e._displayValue=s.displayValue}else e._displayValue=e.value;return e._displayValueInitialized=!0,Promise.resolve(e._displayValue)})()}toMetadata(){return{...super.toMetadata(),value:this.value}}copy(){return new we({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return super.isValid()?this.isLookup?(0,a.isGuid)(this.value):this.value!=null&&this.value!=="":!1}clear(){this._value="",this._displayValue="",this._displayValueInitialized=!1}setValue(e){e?(this.value=e.value,this.displayValue=e.displayValue):this.clear()}getValue(){return{value:this.value,displayValue:this.displayValue}}isEmpty(){return!this.value}};D=we=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleValueExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],D);class K extends b{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetFilter",e&&(this.value=new D(e.value))}clone(){return new K(this.toMetadata())}copy(){return new K(super.copy().toMetadata())}getApplicability(){return this.expression?.path?[{path:this.expression.path}]:[]}isAttributeUsed(e,s){return this.expression.isAttributeUsed(e,s)}}class z extends b{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValue"}clone(){return new z(this.toMetadata())}copy(){return new z(super.copy().toMetadata())}}var pe;(function(i){i.DataSource="DataSource",i.Page="Page"})(pe||(pe={}));class H extends b{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSetValueItem",this.scope=e?.scopeId??"",this.scope==="null"&&(this.scope="")}clone(){return new H(this.toMetadata())}copy(){return new H({...super.copy().toMetadata(),scopeId:this.scope})}toMetadata(){return{...super.toMetadata(),scopeId:this.scope}}getApplicability(){if(!this.expression?.path)return[];const s=this.expression.path.split(".").shift();if(!s)return[];const t={path:s};return this.scope!==""&&(t.applicability=pe.DataSource,t.scope=this.scope),[t]}isAttributeUsed(e,s){return this.expression.path===s&&le(this.scope,e)}}class J extends b{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValues",this.items=[],e&&(this.items=e.items?.map(s=>new H(s)))}getExpressionAffectedItems(){return[]}clone(){return new J(this.toMetadata())}copy(){return new J({...super.copy().toMetadata(),items:this.items.map(e=>e.toMetadata())})}toMetadata(){const e={...super.toMetadata(),items:this.items?.length>0?this.items.map(s=>s.toMetadata()):[]};return this.items?.length>0&&(delete e.expression,delete e.value),e}getApplicability(){return this.items?.length?this.items.flatMap(e=>e.getApplicability()):[]}isValid(){return this.items?.length>0&&this.items.every(e=>e.isValid())}getAffectedItems(){const s=(this.items??[]).map(t=>t.getAffectedItems()).flat();return[...super.getAffectedItems(),...s]}getRequiredItems(){return this.getAffectedItems()}isAttributeUsed(e,s){return this.items.some(t=>t.isAttributeUsed(e,s))}}class X extends I{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionShowElement"}clone(){return new X(this.toMetadata())}copy(){return new X({...this.toMetadata(),uId:(0,a.generateGuid)()})}}class C{get(e){return e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionShowElement"?new X(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionHideElement"?new O(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionReadonlyElement"?new q(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionEditableElement"?new k(e):e.typeName===Te?new $(e):e.typeName===Ve?new W(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionFilterLookup"?new j(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetFilter"?new K(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValue"?new z(e):e.typeName==="Terrasoft.Core.BusinessRules.Models.Actions.BusinessRuleActionSetValues"?new J(e):new b(e)}static{this.\u0275fac=function(s){return new(s||C)}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:C,factory:C.\u0275fac,providedIn:"root"})}}const ce="Terrasoft.Core.BusinessRules.Models.Conditions.BusinessRuleGroupCondition";class Y extends v{constructor(e){super(e),this._businessRuleDesignExpressionFactory=new S,this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BusinessRuleCondition",this.comparisonType=p.BusinessRuleExpressionComparisonType.IsNull,e&&(e.leftExpression&&(this.leftExpression=this._businessRuleDesignExpressionFactory.get(e.leftExpression)),e.rightExpression&&(this.rightExpression=this._businessRuleDesignExpressionFactory.get(e.rightExpression)),e.comparisonType!=null&&(this.comparisonType=e.comparisonType))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),comparisonType:this.comparisonType}}copy(){const e=new Y({...this.toMetadata(),uId:(0,a.generateGuid)()});return e.leftExpression=this.leftExpression?.copy(),e.rightExpression=this.rightExpression?.copy(),e}isValid(){if(!super.isValid()||this.comparisonType==null)return!1;const e=!!this.leftExpression?.isValid();switch(this.comparisonType){case p.BusinessRuleExpressionComparisonType.IsNull:case p.BusinessRuleExpressionComparisonType.IsNotNull:return e;case p.BusinessRuleExpressionComparisonType.Equal:case p.BusinessRuleExpressionComparisonType.NotEqual:return e&&!!this.rightExpression?.isValid();default:return!0}}onDataSourceAttributeNameChanged(e,s,t){this.leftExpression.onDataSourceAttributeNameChanged(e,s,t),this.rightExpression?.onDataSourceAttributeNameChanged(e,s,t)}_getAttributeExpressionWarningMessage(e){if(!e.dataValueTypeName)return null;const s=Object.values(p.DataValueTypeItems).find(t=>t.name===e.dataValueTypeName)?.type;return s===a.DataValueType.MAXSIZE_TEXT?{message:"BusinessRules.Errors.MaxSizeInConditionLimitedWarningMessage",type:"warn"}:s===a.DataValueType.RICH_TEXT||s===a.DataValueType.Image?{message:"BusinessRules.Errors.NotSupportedInConditionTypesWarningMessage",type:"error"}:null}getWarningMessages(){const e=[];if(this.comparisonType===p.BusinessRuleExpressionComparisonType.Equal||this.comparisonType===p.BusinessRuleExpressionComparisonType.NotEqual){if(this.leftExpression instanceof F){const s=this._getAttributeExpressionWarningMessage(this.leftExpression);s&&e.push(s)}if(this.rightExpression instanceof F){const s=this._getAttributeExpressionWarningMessage(this.rightExpression);s&&e.push(s)}}return e}isAttributeUsed(e,s){return this.leftExpression?.isAttributeUsed(e,s)||this.rightExpression?.isAttributeUsed(e,s)}}class Z extends v{constructor(e){super(e),this.typeName=ce,this.logicalOperation=p.LogicalOperation.And,this.conditions=[],e&&(this.logicalOperation=e.logicalOperation,this.conditions=e.conditions?.map(s=>s.typeName===ce?new Z(s):new Y(s))??[])}_copyConditions(){return this.conditions.map(e=>e.copy())}toMetadata(){return{...super.toMetadata(),logicalOperation:this.logicalOperation,conditions:this.conditions.map(e=>e.toMetadata())}}copy(){const e=new Z({...this.toMetadata(),uId:(0,a.generateGuid)()});return e.conditions=this._copyConditions(),e}isValid(){return super.isValid()&&this.conditions?this.conditions.length===0?!0:this.conditions.every(s=>s.isValid()):!1}onDataSourceAttributeNameChanged(e,s,t){this.conditions.forEach(n=>n.onDataSourceAttributeNameChanged(e,s,t))}isAttributeUsed(e,s){return this.conditions.some(t=>t.isAttributeUsed(e,s))}getWarningMessages(){return this.conditions.map(e=>e.getWarningMessages()).flat()}}class Ze{get(e){return e.typeName===ce?new Z(e):new Y(e)}}class Q{get actions(){return Object.freeze(this._actions)}constructor(e){this._businessRuleDesignActionFactory=new C,this._businessRuleDesignConditionFactory=new Ze,this._typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleCase",this._actions=[],this.uId=e?.uId||(0,a.generateGuid)(),e?.condition?this.condition=this._businessRuleDesignConditionFactory.get(e.condition):this.condition=new G,e?.actions?.forEach(s=>{this._actions.push(this._businessRuleDesignActionFactory.get(s))})}_getActionIndex(e){return this.actions.findIndex(s=>s.uId===e.uId)}_actionsUpdateMetadata(e){const s=[];e.actions.forEach(n=>{s.push(n.uId);const r=this._businessRuleDesignActionFactory.get(n);this._getActionIndex(r)!==-1?this.updateAction(r):this.addAction(r)}),this.actions.filter(n=>!s.includes(n.uId)).forEach(n=>this.deleteAction(n))}_getActionsMetadata(){return this.actions.map(e=>e.toMetadata())}_getConditionMetadata(){const e=this.condition;return e&&!(e instanceof G)?e.toMetadata():null}_copyActions(){return this.actions.map(e=>e.copy())}_setActions(e){this._actions=[...e]}_copyCondition(){const e=this.condition;return e&&!(e instanceof G)?e.copy():new G}toMetadata(){const e=this._getConditionMetadata(),s=this._getActionsMetadata();return{typeName:this._typeName,uId:this.uId,condition:e,actions:s}}updateFromMetadata(e){e.condition&&this.updateCondition(this._businessRuleDesignConditionFactory.get(e.condition)),this._actionsUpdateMetadata(e)}addAction(e){if(this._getActionIndex(e)!==-1){console.warn(`Action ${e.uId} already exists`);return}this._actions=[...this._actions,e.clone()]}updateAction(e){const s=this._getActionIndex(e);if(s===-1){console.warn(`Action ${e.uId} not found`);return}this._actions=[...this._actions],this._actions.splice(s,1,e.clone())}deleteAction(e){const s=this._getActionIndex(e);s<0||(this._actions=[...this._actions],this._actions.splice(s,1))}updateCondition(e){this.condition=e}copy(){const e=new Q({...this.toMetadata(),uId:(0,a.generateGuid)()});return e._setActions(this._copyActions()),e.condition=this._copyCondition(),e}onDataSourceAttributeNameChanged(e,s,t){this.condition.onDataSourceAttributeNameChanged(e,s,t),this._actions.forEach(n=>n.onDataSourceAttributeNameChanged(e,s,t))}isAttributeUsed(e,s){return this.condition.isAttributeUsed(e,s)||this._actions.some(t=>t.isAttributeUsed(e,s))}}function Rs(i,e){return Object.values(i).indexOf(e)}class ee{constructor(e){this._typeName="Terrasoft.Core.BusinessRules.Models.Trigger",this.name="",this.type=p.BusinessRuleTriggerType.ChangeAttributeValue,this.scopeId="",this.uId=e?.uId||(0,a.generateGuid)(),e&&(this.name=e.name,this.type=Object.values(p.BusinessRuleTriggerType)[e.type||0],this.scopeId=e.scopeId)}toMetadata(){const e=Rs(p.BusinessRuleTriggerType,this.type);return{typeName:this._typeName,uId:this.uId,name:this.name,type:e,scopeId:this.scopeId}}copy(){return new ee({...this.toMetadata(),uId:(0,a.generateGuid)()})}isAttributeUsed(e,s){return this.name===s&&le(this.scopeId,e)}}function Qe(){return`BusinessRule_${(0,a.generateGuid)().substring(0,7)}`}class he{get hasWarnings(){return this.getWarningMessages().length>0}constructor(e,s,t,n,r){this.caption=s,this.schemaName=t,this.schemaCaption=n,this.applicabilityType=r,this._typeName="Terrasoft.Core.BusinessRules.BusinessRule",this.name="",this.enabled=!0,this.triggers=[],this.cases=[],this.needToSave=!1,this.parentUId="",this.parentActionUId="",this.uId=e.uId,this.updateFromMetadata(e)}_updateCase(e){const s=this.cases.find(t=>t.uId===e.uId);if(s){s.updateFromMetadata(e);return}this.addCase(new Q(e))}_casesUpdateMetadata(e){const s=[];e.cases?.forEach(t=>{s.push(t.uId),this._updateCase(t)}),this.cases=this.cases.filter(t=>s.includes(t.uId))}_copyCases(){return this.cases?.map(e=>e.copy())}_copyTriggers(){return this.triggers?.map(e=>e.copy())}_isValidCaption(){return this.caption.some(e=>e.value)}addTrigger(e,s,t=""){const n=Object.values(p.BusinessRuleTriggerType).indexOf(s),r=new ee({name:e,type:n,scopeId:t});return this.triggers.push(r),r.uId}addCase(e){this.cases.push(e)}getFirstCase(){let e=this.cases[0];return e||(e=new Q,this.addCase(e),this.getFirstCase())}updateFromMetadata(e){this.parentUId=e.parentUId??"",this.parentActionUId=e.parentActionUId??"",this.name=e.name,this.enabled=e.enabled,this._casesUpdateMetadata(e),this.triggers=e.triggers?.map(s=>new ee(s))??[]}toMetadata(){const e={typeName:this._typeName,uId:this.uId,cases:this.cases.map(s=>s.toMetadata()),triggers:this.triggers.map(s=>s.toMetadata()),name:this.name,enabled:this.enabled};return this.parentUId&&(e.parentUId=this.parentUId),this.parentActionUId&&(e.parentActionUId=this.parentActionUId),e}clone(){const e=new he(this.toMetadata(),this.caption.clone(),this.schemaName,this.schemaCaption,this.applicabilityType);return e.needToSave=this.needToSave,e}copy(){const e=this.caption.clone();e.forEach(t=>{t.value&&(t.value=`Copy ${t.value}`)});const s=new he({...this.toMetadata(),uId:(0,a.generateGuid)()},e,this.schemaName,this.schemaCaption,this.applicabilityType);return s.name=Qe(),s.cases=this._copyCases(),s.triggers=this._copyTriggers(),s}isValid(){if(!this._isValidCaption())return!1;const s=this.getFirstCase(),t=s?.condition,n=s?.actions;return t?.isValid()&&n?.length>0&&n.every(r=>r.isValid())}showInvalid(){return this.needToSave?!this.isValid():!1}onDataSourceAttributeNameChanged(e,s,t){this.cases.forEach(n=>n.onDataSourceAttributeNameChanged(e,s,t))}getWarningMessages(){const e=[],t=this.getFirstCase()?.condition;return t&&e.push(...t.getWarningMessages()),e}isAttributeUsed(e,s){return this.cases.some(t=>t.isAttributeUsed(e,s))||this.triggers.some(t=>t.isAttributeUsed(e,s))}}var ve;let Fe=ve=class extends E{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysSettingExpression",this.sysSettingName="",e&&(this.sysSettingName=e.sysSettingName)}toMetadata(){return{...super.toMetadata(),sysSettingName:this.sysSettingName}}copy(){return new ve({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return super.isValid()&&!!this.sysSettingName}};Fe=ve=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysSettingExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],Fe);var De;let Pe=De=class extends E{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysValueExpression",this.sysValueName="",e&&(this.sysValueName=e.sysValueName)}toMetadata(){return{...super.toMetadata(),sysValueName:this.sysValueName}}copy(){return new De({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return super.isValid()&&!!this.sysValueName}};Pe=De=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleSysValueExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],Pe);var Ue;let Ge=Ue=class extends E{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterValueExpression",this.leftExpression="",e&&(this.leftExpression=e.leftExpression,this.rightExpression=new D(e.rightExpression))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression,rightExpression:this.rightExpression?.toMetadata()}}copy(){const e=new Ue({...this.toMetadata(),uId:(0,a.generateGuid)()});return e.rightExpression=this.rightExpression.copy(),e}isValid(){return super.isValid()&&!!this.leftExpression&&!!this.rightExpression&&this.rightExpression.isValid()}getAffectedItem(){return{name:this.leftExpression}}};Ge=Ue=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFilterValueExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],Ge);let ke=class extends D{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleEmptyValueExpression"}isValid(){return!0}};ke=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleEmptyValueExpression"})],ke);var de=R(52972);class se{constructor(e){this._expressionFactory=new S,this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.ParameterMapping",this.parameterName="",this.expression=null,this.uId=e?.uId||(0,a.generateGuid)(),this.parameterName=e?.parameterName??"",this.expression=this._expressionFactory.get(e?.expression)}toMetadata(){return{typeName:this.typeName,uId:this.uId,expression:this.expression.toMetadata(),parameterName:this.parameterName}}copy(){return new se({...this.toMetadata(),uId:(0,a.generateGuid)()})}isValid(){return this.parameterName!==""&&this.expression.isValid()}}var Le;let je=Le=class extends E{constructor(e){super(e),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFormulaExpression",this.parameterMappings=[],this.type=p.BusinessRuleExpressionType.Formula,this.expressionSchema=new de.ExpressionSchema;const s=e?.parameterMappings??[];this.parameterMappings=s.map(t=>new se(t)),this.expressionSchema=de.ExpressionSchema.fromMetadata(e?.expressionSchema)}toMetadata(){return{...super.toMetadata(),parameterMappings:this.parameterMappings.map(e=>e.toMetadata()),expressionSchema:this.expressionSchema.toMetadata()}}copy(){return new Le({...this.toMetadata(),uId:(0,a.generateGuid)()})}clear(){this.expressionSchema=new de.ExpressionSchema,this.parameterMappings=[]}setValue(e){const s=e?.value;this.expressionSchema=s?s.expressionSchema.clone():new de.ExpressionSchema,this.parameterMappings=s?s.mappings.map(t=>{const n=new se;return n.parameterName=t.parameterName,n.expression=t.mapping.copy(),n}):[]}getValue(){const e=this.parameterMappings.map(s=>({parameterName:s.parameterName,mapping:s.expression}));return{value:{expressionSchema:this.expressionSchema,mappings:e},displayValue:"Formula"}}isEmpty(){return!this.expressionSchema}};je=Le=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleFormulaExpression"}),(0,d.__metadata)("design:paramtypes",[Object])],je);var Oe;let $e=Oe=class extends E{constructor(){super(...arguments),this.typeName="Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleContextExpression"}copy(){return new Oe({...this.toMetadata(),uId:(0,a.generateGuid)()})}};$e=Oe=(0,d.__decorate)([M({typeName:"Terrasoft.Core.BusinessRules.Models.Expressions.BusinessRuleContextExpression"})],$e);const xs=new h.InjectionToken("BusinessRulesRepository");var te;(function(i){i[i.Condition=0]="Condition",i[i.Action=1]="Action",i[i.Trigger=2]="Trigger",i[i.Context=3]="Context",i[i.Unknown=4]="Unknown"})(te||(te={}));class es{}var qe=R(63721),g=R(36486);function ss(i){return i&&"path"in i?i.path:""}function As(i){const e=[];return i.conditions&&i.conditions.forEach(s=>{const t=ts(s);e.push(...t)}),e}function ts(i){if(is(i))return As(i);const e=i;return[ss(e.leftExpression),ss(e.rightExpression)].filter(s=>s)}function Es(i,e){return i.flatMap(s=>e.get(s).getRequiredItems()).map(s=>s.name)}function is(i){return i.typeName===ce}function ns(i){return i.map(e=>ts(e)).flat().filter(e=>e!=null)}function Bs(i,e){return i.flatMap(s=>s.cases.flatMap(t=>Es(t.actions,e)))}function Ns(i){return!i.cases||i.cases.length===0?[]:i.cases.map(e=>e.condition).filter(e=>e!=null)}function rs(i){return i.map(e=>Ns(e)).flat()}var os=R(28399);const bs=[p.BusinessRuleExpressionType.Const,p.BusinessRuleExpressionType.SysValue,p.BusinessRuleExpressionType.SysSetting],_s=new Set(bs);function as(i){return i?!!i.type&&_s.has(i.type):!0}function Ms(i){return i.conditions?i.conditions.every(e=>us(e)):!1}function us(i){if(!i)return!1;if(is(i))return Ms(i);const e=i;return(0,os.isNil)(e.leftExpression)&&(0,os.isNil)(e.rightExpression)?!1:as(e.leftExpression)&&as(e.rightExpression)}function ls(i){return i.some(e=>e.type===p.BusinessRuleTriggerType.ContextReady)}function Cs(i,e){return ls(i)?e.some(s=>us(s)):!1}function Ss(i,e){return ls(i)?e.some(s=>s.cases?.some(t=>!t.condition)):!1}class T{_canExecuteByConditionsAttributePaths(e,s){const t=e.filter(r=>r.type!==p.BusinessRuleTriggerType.DataLoaded).map(r=>r.name);if(!t||t.length===0)return!1;const n=new Set(ns(s));return t.some(r=>n.has(r))}canExecute(e,s){if(!s||s.length===0)return!1;const t=rs(s),n=Cs(e.triggers,t),r=Ss(e.triggers,s);return n||r?!0:this._canExecuteByConditionsAttributePaths(e.triggers,t)}static{this.\u0275fac=function(s){return new(s||T)}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac})}}class V extends es{constructor(e,s){super(),this._httpClient=e,this.dbService=s,this._cachedLoadScopesRequests=new Map,this.serviceEndpoint="/ServiceModel/BusinessRulesManagerService.svc/",this.getBusinessRulesConfigMethodName="GetBusinessRules"}_getCachedBusinessRulesScopes(e){const s=e.map(t=>{const n=this._getContextCacheKey(t.scopeType,t.scopeName);return this.dbService.getByKey("business-rules",n).pipe((0,l.map)(r=>r?{rules:r.data,scopeName:t.scopeName,scopeType:t.scopeType}:null))});return s.length?(0,l.forkJoin)(s):(0,l.of)([])}_getScopeType(e){return e==="Model"?A.Model:A.ViewModel}_mapResponseToBusinessRules(e){return!e?.businessRules||e.businessRules.length===0?[]:e.businessRules.map(s=>{const t=JSON.parse(s.businessRulesConfig);return{scopeName:s.schemaName,scopeType:this._getScopeType(s.type),rules:t}})}_getContextsScopeNames(e){return e.map(s=>s.scopeName)}_getContextCacheKey(e,s){return`Type:#${e}#-Name:#${s}#`}_getContextsScopeNamesRequestKey(e){return e.map(t=>this._getContextCacheKey(t.scopeType,t.scopeName)).join("_")}_getCachedLoadScopesRequest(e){const s=e.map(n=>this._getContextCacheKey(n.scopeType,n.scopeName)),t=[...this._cachedLoadScopesRequests.keys()].find(n=>s.every(r=>n.includes(r)));return this._cachedLoadScopesRequests.get(t)}_getNotLoadedBusinessRulesScopes(e){if(e.length===0)return(0,l.of)([]);const s=this._getContextsScopeNames(e),t=this._getCachedLoadScopesRequest(e);if(t)return t.request$.pipe((0,l.map)(u=>u.filter(c=>s.includes(c.scopeName))));const n=`${this.serviceEndpoint}${this.getBusinessRulesConfigMethodName}`,r={scopes:e.map(u=>({name:u.scopeName,type:u.scopeType,modelType:u.modelType}))},o=this._httpClient.post(n,r).pipe((0,l.map)(u=>this._mapResponseToBusinessRules(u)),(0,l.switchMap)(u=>{const c=u.map(m=>{const y=this._getContextCacheKey(m.scopeType,m.scopeName);return this.dbService.add("business-rules",{data:m.rules,key:y})});return c.length?(0,l.forkJoin)(c).pipe((0,l.map)(()=>u)):(0,l.of)(u)}),(0,l.tap)(()=>{const u=this._getContextsScopeNamesRequestKey(e);this._cachedLoadScopesRequests.delete(u)}),(0,l.share)());return this._cachedLoadScopesRequests.set(this._getContextsScopeNamesRequestKey(e),{request$:o,scopeNames:s}),o}getBusinessRulesByContexts(e){const s=e.filter(t=>t.scopeName&&t.modelType!=="crt.PageParametersDataSource");return this._getCachedBusinessRulesScopes(s).pipe((0,l.switchMap)(t=>{const n=s.filter(o=>!t?.some(u=>u?.scopeName===o.scopeName&&u.scopeType===o.scopeType));return this._getNotLoadedBusinessRulesScopes(n).pipe((0,l.map)(o=>[...t,...o].filter(Boolean)),(0,l.catchError)(o=>{const u=s?.map(c=>c.scopeName).join(", ");return console.warn(`An error occurred during getting business rules execution for scopes: ${u}.`,o),(0,l.of)([])}))}))}clearCachedBusinessRules(){return this.dbService.clear("business-rules")}static{this.\u0275fac=function(s){return new(s||V)(h.\u0275\u0275inject(qe.HttpClient),h.\u0275\u0275inject(p.CrtIndexedDBService,8))}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"})}}const ps=new Map([[0,p.BusinessRuleTriggerType.ChangeAttributeValue],[1,p.BusinessRuleTriggerType.ChangeAttributeProperty],[2,p.BusinessRuleTriggerType.DataLoaded]]);function We(i){return ps.has(i)?ps.get(i):p.BusinessRuleTriggerType.DataLoaded}class ie{constructor(e,s){this._businessRulesManager=e,this._businessRuleDesignActionFactory=s,this._scopeAttributes=[]}_filterTriggers(e,s){const t=s.filter(o=>o.scopeName===e.parentScopeId),r=s.find(o=>o.scopeName===e.scopeName&&o.scopeType===e.scopeType)?.rules.map(o=>o.triggers).flat();return e.triggers.filter(o=>{if(o.type===p.BusinessRuleTriggerType.ContextReady||o.type===p.BusinessRuleTriggerType.DataLoaded)return!0;const u=r?.some(y=>y&&y.name===o.name&&We(y.type)===o.type),m=t.flatMap(y=>y.rules.flatMap(Ke=>Ke.triggers)).some(y=>y.name===o.name&&We(y.type)===o.type);return u||m})}_filterAttributes(e){const t=this._scopeAttributes.filter(o=>o.scopeName===e.scopeName).map(o=>o.attributes).flat(),n=this._scopeAttributes.filter(o=>o.scopeName!==e.scopeName).flatMap(o=>[...o.attributes]);return e.attributes.filter(o=>t.includes(o.attributeName)||n.includes(o.attributeName)||o.isSignificant)}_cacheUsedAttributes(e){e.forEach(s=>{if(!this._scopeAttributes.find(t=>t.scopeName===s.scopeName&&t.scopeType===s.scopeType)){const t=rs(s.rules),n=ns(t),r=Bs(s.rules,this._businessRuleDesignActionFactory),o=s.rules.flatMap(u=>u.triggers?.map(c=>c.name)).filter(Boolean);this._scopeAttributes.push({scopeName:s.scopeName,scopeType:s.scopeType,attributes:[...n,...r,...o]})}})}clearCachedScopeAttributes(){this._scopeAttributes=[]}filter(e){return this._businessRulesManager.getBusinessRulesByContexts(e).pipe((0,l.tap)(s=>this._cacheUsedAttributes(s)),(0,l.map)(s=>e.map(t=>({...t,attributes:this._filterAttributes(t),triggers:this._filterTriggers(t,s)}))))}static{this.\u0275fac=function(s){return new(s||ie)(h.\u0275\u0275inject(V),h.\u0275\u0275inject(C))}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:ie,factory:ie.\u0275fac,providedIn:"root"})}}class w{canExecute(e,s,t){const n=t.map(r=>r.triggers).flat();return n.length===0?!1:n.some(r=>{const o=We(r.type);if(o===p.BusinessRuleTriggerType.DataLoaded&&e.scopeType===A.Model)return e.triggers.some(c=>c.type===p.BusinessRuleTriggerType.DataLoaded);if(!r.scopeId)return e.triggers.some(c=>c.name===r.name&&c.type===o);const u=s.find(c=>c.scopeId===r.scopeId);return u==null?!1:u.triggers.some(c=>c.name===r.name&&c.type===o)})}static{this.\u0275fac=function(s){return new(s||w)}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac})}}class P{constructor(e,s,t,n,r,o,u){this._businessRulesManager=e,this._businessRulesTriggerExecutor=s,this._businessRulesConditionExecutor=t,this._httpClient=n,this._messageChannelService=r,this._featureService=o,this._contextFilter=u,this._businessRulesResponseEventName="BusinessRuleExecutionResponse",this._serviceUrl="ServiceModel/BusinessRulesEngineService.svc/Execute",this._businessRulesRequestEventName="BusinessRuleExecutionRequest",this._businessRuleDesignActionFactory=new C,this._configurationStructureChangedSubscribe()}_configurationStructureChangedSubscribe(){this._messageChannelService.getMessages("ConfigurationStructureChanged").pipe((0,g.switchMap)(()=>(this._contextFilter.clearCachedScopeAttributes(),this._businessRulesManager.clearCachedBusinessRules()))).subscribe()}_featureStates(){return(0,l.from)(this._featureService.getFeaturesState(["BRules-UseWebSocketChannel","BRules-DisableContextOptimization"])).pipe((0,g.map)(([e,s])=>({useHttpChannel:!e,disableContextOptimization:s})))}_sendWebSocketMessage(e){const s=(0,a.generateGuid)();return e.businessRulesSessionId=s,new l.Observable(t=>{const n=this._messageChannelService.messageEvent$.pipe((0,g.map)(r=>r.body),(0,g.filter)(r=>r!=null),(0,g.filter)(r=>r.eventName===this._businessRulesResponseEventName),(0,g.filter)(r=>r.businessRulesSessionId===s),(0,g.map)(r=>r.payload)).subscribe({next:r=>{n.unsubscribe(),r.success?t.next(r.businessRulesResponse):(console.error("An error occurred during business rules execution. "+r.errorInfo.errorCode+": "+r.errorInfo.message),t.next([])),t.complete()},error:r=>{n.unsubscribe(),console.error("An error occurred during business rules execution. "+r.errorCode+": "+r.message),t.next([]),t.complete()},complete:()=>{n.unsubscribe(),t.error("WebSocket channel closed")}});this._messageChannelService.sendMessage(e,a.MessageChannelType.PTP).pipe((0,l.take)(1)).subscribe()})}_createWebSocketRequest(e){return{eventName:this._businessRulesRequestEventName,contexts:e}}_executeUsingWebSocket(e){const s=this._createWebSocketRequest(e);return this._sendWebSocketMessage(s)}_logErrorMessageAndReturnDefBusinessRuleResponse(e){return console.error("An error occurred during business rules execution. "+e.errorCode+": "+e.message),(0,l.of)([])}_executeUsingHttp(e){return this._httpClient.post(this._serviceUrl,{contexts:e},{headers:new qe.HttpHeaders({"Content-Type":"application/json"})}).pipe((0,g.mergeMap)(s=>s.success?(0,l.of)(s.businessRulesResponse):this._logErrorMessageAndReturnDefBusinessRuleResponse(s.errorInfo)),(0,g.catchError)(s=>this._logErrorMessageAndReturnDefBusinessRuleResponse(s)))}_canExecuteBusinessRulesByContexts(e){return this._businessRulesManager.getBusinessRulesByContexts(e).pipe((0,g.map)(s=>{const t=s.filter(n=>n.rules&&n.rules.length>0);return t.length===0?!1:t.some(n=>{const r=e.find(m=>m.scopeName===n.scopeName),o=e.filter(m=>m.parentScopeId===r.scopeId),u=this._businessRulesTriggerExecutor.canExecute(r,o,n.rules),c=this._businessRulesConditionExecutor.canExecute(r,n.rules);return u||c})}))}_getContextsWithScope(e){return e.filter(s=>s.scopeName&&s.scopeId)}_getBusinessRuleActions(e){return e.cases.map(s=>s.actions).flat().filter(s=>s.enabled).map(s=>this._businessRuleDesignActionFactory.get(s))}_getBusinessRuleAffectedAttributes(e){return this._getBusinessRuleActions(e).map(t=>t.getAffectedItems()).flat()}_getAffectedAttributes(e){let s=e.rules.filter(t=>t.enabled).map(t=>this._getBusinessRuleAffectedAttributes(t)).flat();return s=this._getUniqueAffectedAttributes(s),s.forEach(t=>{t.scopeName=e.scopeName}),s}_getUniqueAffectedAttributes(e){const s=e.map(n=>[n.name,n]);return[...new Map(s).values()]}_execute(e){return this._featureStates().pipe((0,g.switchMap)(({useHttpChannel:s,disableContextOptimization:t})=>(0,l.forkJoin)({useHttpChannel:(0,l.of)(s),executionContexts:t?(0,l.of)(e):this._contextFilter.filter(e)})),(0,g.switchMap)(({useHttpChannel:s,executionContexts:t})=>(s?this._executeUsingHttp(t):this._executeUsingWebSocket(t)).pipe((0,g.map)(n=>({executionResults:n,executionContexts:t})))),(0,g.switchMap)(({executionResults:s,executionContexts:t})=>this._logUnsuccessfulBusinessRulesExecution(s,t).pipe((0,g.map)(()=>s))))}_logUnsuccessfulBusinessRulesExecution(e,s){const t=e?.filter(n=>n?.errors?.length>0).map(n=>n.errors).flat();return t?.length===0?(0,l.of)(void 0):(0,l.from)(this._featureService.getFeatureState("BRules-ShowChildRules")).pipe((0,g.switchMap)(n=>this._businessRulesManager.getBusinessRulesByContexts(s).pipe((0,g.map)(r=>r.map(o=>o.rules).flat()),(0,g.tap)(r=>{t.map(o=>this._getUnsuccessfulBusinessRuleExecutionMessage(o,r,n)).forEach(o=>{console.error(o)})}),(0,g.map)(()=>{}))))}_getUnsuccessfulBusinessRuleExecutionMessage(e,s,t){const n="Business rule execution error: ",r=`Error message: "${e.message}"`,o=e.type===te.Unknown?"":`The error occurred in the business rule ${te[e.type]?.toLocaleLowerCase()}s.`;let u=s.find(ze=>ze.uId===e.businessRuleId);if(!u)return`${n}Rule id - "${e.businessRuleId}". ${r}. ${o}`;!(0,a.isEmptyGuid)(u.parentUId)&&!t&&(u=s.find(ze=>ze.uId===u.parentUId));const c=u.caption||"",m=u.name,y=`Rule Title - "${c}"`,Ke=`Rule Code - "${m}"`;return`${n}${y}, ${Ke}. ${r}. ${o}`}execute(e){const s=this._getContextsWithScope(e);return s.length===0?(0,l.of)([]):this._canExecuteBusinessRulesByContexts(e).pipe((0,g.switchMap)(t=>t?this._execute(s):(0,l.of)([])),(0,g.catchError)(t=>(console.warn(`An error occurred during business rules execution for scopes: ${e?.map(n=>n.scopeName).join(", ")}.`,t),(0,l.of)([]))))}getAffectedAttributes(e){var s=this;return(0,f.A)(function*(){if(e.length===0)return[];const t=e.filter(o=>o.scopeName!=null),r=(yield(0,l.firstValueFrom)(s._businessRulesManager.getBusinessRulesByContexts(t))).filter(o=>o.rules&&o.rules.length>0);return r.length===0?[]:r.map(o=>s._getAffectedAttributes(o)).flat()})()}static{this.\u0275fac=function(s){return new(s||P)(h.\u0275\u0275inject(V),h.\u0275\u0275inject(w),h.\u0275\u0275inject(T),h.\u0275\u0275inject(qe.HttpClient),h.\u0275\u0275inject(p.MessageChannelService),h.\u0275\u0275inject(a.FeatureService),h.\u0275\u0275inject(ie))}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:P,factory:P.\u0275fac})}}class U{constructor(e){this._actionApplierFactory=e}_applyBusinessRuleAction(e,s,t){const n=this._actionApplierFactory.get(t);return(0,l.firstValueFrom)(n.apply(e,s))}_applyBusinessRule(e,s){var t=this;return(0,f.A)(function*(){const n={id:s.scopeId,name:s.scopeName,type:s.scopeType,triggers:s.triggers};if(s.actions.length===0)return Promise.resolve(null);const r=[];for(const o of s.actions){const u=yield t._applyBusinessRuleAction(e,n,o);r.push(u)}return r})()}_applyBusinessRules(e,s){var t=this;return(0,f.A)(function*(){const n=[];for(const r of s){const o=yield t._applyBusinessRule(e,r);n.push(o)}return n})()}applyRules(e,s){return s&&s.length>0?(0,l.from)(this._applyBusinessRules(e,s)):(0,l.of)(null)}static{this.\u0275fac=function(s){return new(s||U)(h.\u0275\u0275inject(x))}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:U,factory:U.\u0275fac})}}class ne{constructor(e){this._storageService=e,this._isBusinessRulesPropertiesPanelExpandedKey="isBusinessRulesPropertiesPanelExpanded",this._isBusinessRulePropertiesPanelExpanded=!0;const s=this._storageService.get(this._isBusinessRulesPropertiesPanelExpandedKey);this._isBusinessRulePropertiesPanelExpanded=s==="true",this.businessRulesPropertiesPanelExpandedChanged$=new l.BehaviorSubject(this._isBusinessRulePropertiesPanelExpanded)}changeBusinessRulePropertiesPanelExpandedState(e){e===void 0&&(e=!this._isBusinessRulePropertiesPanelExpanded),this._isBusinessRulePropertiesPanelExpanded=e,this._storageService.set(this._isBusinessRulesPropertiesPanelExpandedKey,`${e}`),this.businessRulesPropertiesPanelExpandedChanged$.next(e)}static{this.\u0275fac=function(s){return new(s||ne)(h.\u0275\u0275inject(p.StorageService))}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:ne,factory:ne.\u0275fac})}}function Is(i){return(0,f.A)(function*(){const e=i.get(p.ApplicationInfoService,null),s=i.get(p.CrtIndexedDBService,null);if(!e||!s){console.warn("ApplicationInfoService or CrtIndexedDBService not provided for businessRulesDBInitializerFactory");return}try{const n=(yield(0,l.lastValueFrom)(e.loadApplicationInfo())).applicationInfo?.configurationContentHash,r="business-rules";if(n){const o="business-rules-hash",u="common",c=yield(0,l.firstValueFrom)(s.getByKey(u,o));c?.data!==n&&(yield(0,l.lastValueFrom)(s.clear(r)),c?yield(0,l.lastValueFrom)(s.update(u,{id:c.id,key:o,data:n})):yield(0,l.lastValueFrom)(s.add(u,{key:o,data:n})))}else yield(0,l.lastValueFrom)(s.clear(r))}catch(t){console.error("Error initializing business rules cache db",t)}})}class ge{static{this.\u0275fac=function(s){return new(s||ge)}}static{this.\u0275mod=h.\u0275\u0275defineNgModule({type:ge})}static{this.\u0275inj=h.\u0275\u0275defineInjector({providers:[P,U,x,w,T,{provide:h.APP_INITIALIZER,useFactory:Is,deps:[h.Injector],multi:!0}]})}}class fe extends ue{constructor(e){super(),this.uId=e?.uId||(0,a.generateGuid)(),this.customField=e?.customField||"",this.typeName=e?.typeName||""}toMetadata(){return{uId:this.uId,typeName:this.typeName,customField:this.customField}}clone(){return new fe(this.toMetadata())}copy(){return new fe({...this.toMetadata(),uId:(0,a.generateGuid)()})}onDataSourceAttributeNameChanged(e,s){throw new Error("Method not implemented.")}}},73308:(cs,re,R)=>{R.d(re,{A:()=>a});function d(p,l,h,x,B,A,_){try{var N=p[A](_),f=N.value}catch(oe){h(oe);return}N.done?l(f):Promise.resolve(f).then(x,B)}function a(p){return function(){var l=this,h=arguments;return new Promise(function(x,B){var A=p.apply(l,h);function _(f){d(A,x,B,_,N,"next",f)}function N(f){d(A,x,B,_,N,"throw",f)}_(void 0)})}}}}]);
