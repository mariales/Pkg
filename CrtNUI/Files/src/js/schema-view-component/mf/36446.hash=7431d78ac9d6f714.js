(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[36446,73308,50927,28546,6165,62832,40451,18070,95689,94260,71879,41421,63802,86183,8564,30945,53326,75707,98088,20469,42850,70422,48041,15184,92803,80898,58517,25660,3279,91374,68993,83231,5612,38469,14065],{14065:(O,y,l)=>{l.r(y),l.d(y,{BaseRelatedInMainRecordsHandler:()=>F,BaseRelatedInMainRecordsService:()=>_,OpenBaseSelectSelectionWindowHandler:()=>P,OpenBaseSelectSelectionWindowRequest:()=>E,OpenSelectionWindowRequest:()=>N,PAGE_LOOKUP_DATA_TOKEN:()=>M,PAGE_LOOKUP_RESULT_TYPE_DEFAULT_VALUE:()=>w,PageLookupResultType:()=>S,RelatedRecordsActionsEnum:()=>p,SelectionApiMode:()=>C,SelectionWindowResult:()=>V});var A=l(63721),g=l(59131),a=l(38495),f=l(79772),v=l(21018),c=l(28399),h=l(62278),p;(function(o){o[o.AddRelatedRecords=0]="AddRelatedRecords",o[o.RemoveRelatedRecords=1]="RemoveRelatedRecords"})(p||(p={}));class _{constructor(){this._translateService=(0,g.inject)(f.TranslateService),this._httpClient=(0,g.inject)(A.HttpClient),this._userInfo=(0,g.inject)(v.UserInfo)}get _relatedInMainRecordsServiceEndpoint(){return(this._userInfo.isSSP?"ssp/":"")+`rest/${this.relatedInMainRecordsServiceName}/`}_isInvalidParameters(e){return(0,c.isEmpty)(e.relatedRecordsSchemaName)||(0,c.isEmpty)(e.relatedInMainRecordsSchemaName)||(0,c.isEmpty)(e.relatedRecordColumnName)||(0,c.isEmpty)(e.mainRecordColumnName)||!this._isValidFilters(e.relatedRecordsFilters)||!this._isValidFilters(e.mainRecordsFilters)}_isValidFilters(e){return(0,c.isObject)(e)&&"items"in e&&!(0,c.isEmpty)(e.items)}_catchHttpErrorResponse(e){return(0,h.of)({success:!1,message:e.error?.errorInfo?.message??e.message})}_createEsqWithFilters(e,t){const s=new a.EntitySchemaQuery(e);return this._addFiltersToEsq(s,t),s}_addFiltersToEsq(e,t){Object.entries(t.items).forEach(([s,r])=>{e.filters.add(r,s)})}getServiceResultMessage(e,t,s){if(e.success){const r=this.relatedRecordsActionsNames.get(t);return this._translateService.instant(`${this.relatedInMainRecordsServiceName}.ServiceResult.${r}${s}`,{count:(0,c.get)(e,"processedRecordsCount",null)})}return e.errorInfo?.message||this._translateService.instant("BaseRelatedInMainRecordsService.ServiceResult.ErrorMessage")}executeAction(e,t){return this._isInvalidParameters(t)?(0,h.of)({success:!1,message:this._translateService.instant("BaseRelatedInMainRecordsService.NotValidParametersMessage")}):this.process(e,t)}process(e,t){const s=this.createRelatedRecordsEsq(t),r=this.createMainRecordsEsq(t),i=this.createRequest(s,r,t);return this.callService(e,i,t)}createRelatedRecordsEsq(e){return this._createEsqWithFilters(e.relatedRecordsSchemaName,e.relatedRecordsFilters)}createMainRecordsEsq(e){return this._createEsqWithFilters(e.mainRecordsSchemaName,e.mainRecordsFilters)}callService(e,t,s){const r=this.relatedRecordsActionsNames.get(e);return this._httpClient.post(`${this._relatedInMainRecordsServiceEndpoint}${r}`,{request:t}).pipe((0,h.map)(i=>({success:i.success,message:this.getServiceResultMessage(i,e,"Message")})),(0,h.catchError)(i=>this._catchHttpErrorResponse(i)))}addRelatedRecords(e){return this.executeAction(p.AddRelatedRecords,e)}removeRelatedRecords(e){return this.executeAction(p.RemoveRelatedRecords,e)}}var n=l(73308),R=l(59564),k=l(20822);class F extends a.BaseRequestHandler{constructor(e){super(),this.injector=e,this.notifyService=e.get(R.NotifyService),this.maskService=e.get(a.MaskService),this.messageDialogProvider=e.get(k.MessageDialogProvider)}_getOpenLookupPageRequestConfig(e){return{type:"crt.OpenSelectionWindowRequest",$context:e.$context,scopes:e.scopes,features:this.getLookupPageFeatures(),entitySchemaName:this.getLookupPageEntitySchemaName(e),caption:this.getLookupPageCaption(e),filtersConfig:this._getLookupPageFiltersConfig(e),afterClosed:s=>this._afterClosedLookupPageAction(e,s)}}_getLookupPageFiltersConfig(e){const t=this.getLookupPageFilter(e);if(!t)return;const s="lookup_page_filter";return{filterAttributes:[{name:s,loadOnChange:!1}],attributesConfig:{[s]:{value:t}}}}_afterClosedLookupPageAction(e,t){t.canceled||(this.maskService.showMask(this.getMaskTaskName(e),e.$context),this.runServiceAction(e,t.filter).pipe((0,h.tap)(()=>{this.maskService.hideMask(this.getMaskTaskName(e),e.$context)})).subscribe(s=>{this._processServiceResult(e,s)}))}_processServiceResult(e,t){const s={message:t.message};if(t.success){this.showSuccessNotification(e,s);return}this.notifyService.error(s)}_validateRequest(e){return this._validateRequestDataSource(e)&&this._validateRequestFilters(e)}_validateRequestDataSource(e){return e.dataSourceName?!0:(this.messageDialogProvider.error("InfoDialog.SettingsErrorMessage"),!1)}_validateRequestFilters(e){return this._isValidFilters(e.filters)?!0:(this.notifyService.error({message:this.invalidErrorMessageForSelectRecordsValidator}),!1)}_isValidFilters(e){return(0,c.isObject)(e)&&"items"in e&&!(0,c.isEmpty)(e.items)}getLookupPageFeatures(){return{create:{enabled:!1},select:{multiple:!0,selectAll:!1}}}getLookupPageFilter(e){return null}showSuccessNotification(e,t){this.notifyService.show(t)}getRelatedRecordsSchemaName(e){return e.$context.dataSchemas[e.dataSourceName]?.name}runServiceAction(e,t){const s=this.createServiceData(e,t);return this.openLookupPageMode==="AddRecords"?this.addRecordsServiceAction(s):this.removeRecordsServiceAction(s)}addRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.addRelatedRecords(e)}removeRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.removeRelatedRecords(e)}initializeData(e){}handle(e){var t=this;return(0,n.A)(function*(){if(!t._validateRequest(e))return;yield t.initializeData(e);const s=t._getOpenLookupPageRequestConfig(e);yield t.handlerChain.process(s)})()}}var I=l(5960),S;(function(o){o.LookupValues="lookupValues",o.Filter="filter"})(S||(S={}));const w=S.LookupValues;var C;(function(o){o[o.Legacy=0]="Legacy",o[o.New=1]="New"})(C||(C={}));const M=new g.InjectionToken("PageLookupDataToken");class V{get canceled(){return this._canceled}get filter(){return this._filter}constructor(e){this._cachedLookupValues=[],this._entityName=e?.entityName,this._selectionState=e?.selectionState,this._filter=e?.filter,this._cachedLookupValues=e?.cachedLookupValues??[],this._canceled=e?.canceled??!1}_getFilterByPrimaryValues(e,t){const s=new a.EntitySchemaQuery("tempTable"),r=new a.ColumnExpression({columnPath:e}),i=t.map(u=>new a.ParameterExpression({value:u})),m=new a.InFilter(a.ComparisonType.Equal,r,i);return s.filters.add(m),s.getMetadata().filters}_loadLookupValues(e,t,s,r){return(0,n.A)(function*(){const{primaryAttributeName:i,primaryDisplayAttributeName:m,primaryColorAttributeName:d}=t,u=[i,m,d].filter(Boolean);return(yield e.load({attributes:u,parameters:[{type:a.ModelParameterType.Filter,value:s}],options:r?{pagingConfig:r}:{}})).map(L=>({value:L[i],displayValue:L[m],primaryColorValue:L[d]}))})()}_loadLookupValuesByPrimaryValues(e,t){var s=this;return(0,n.A)(function*(){if(!t.length)return[];const r=yield a.Model.create(e),i=yield r.getSchema(),m=s._getFilterByPrimaryValues(i.primaryAttributeName,t);return s._loadLookupValues(r,i,m)})()}_isCached(e){return this._cachedLookupValues.some(t=>t.value===e)}getLookupValues(e){var t=this;return(0,n.A)(function*(){if(!t._selectionState||t.canceled)return[];const s=e?.pagingConfig;if(t._selectionState?.type==="specific"){let r;(0,c.isUndefined)(s?.rowsOffset)||(0,c.isUndefined)(s?.rowCount)?r=[...t._selectionState.selected]:r=t._selectionState.selected.slice(s?.rowsOffset,s?.rowsOffset+s?.rowCount);const i=r.filter(d=>!t._isCached(d)),m=yield t._loadLookupValuesByPrimaryValues(t._entityName,i);return r.map(d=>t._cachedLookupValues.find(u=>u.value===d)||m.find(u=>u.value===d))}else{const r=yield a.Model.create(t._entityName),i=yield r.getSchema();return t._loadLookupValues(r,i,t._filter,s)}})()}}let N=class extends a.BaseRequest{};N=(0,I.__decorate)([(0,a.CrtRequest)({type:"crt.OpenSelectionWindowRequest"})],N);const x="ItemsFilter";let P=class extends a.BaseRequestHandler{constructor(e){super(),this._maskService=e}_getOpenLookupPageRequestConfig(e){var t=this;return(0,n.A)(function*(){const s=yield t._getSelectedIds(e),r=yield t._getItemsFilter(e),i=t._getIsCreateEnabled(e);return{type:"crt.OpenSelectionWindowRequest",$context:e.$context,scopes:e.scopes,features:{create:{enabled:i},select:{multiple:!0,selectAll:!1,resultType:S.LookupValues}},itemsAttributeName:e.itemsAttributeName,selectionState:{type:"specific",selected:s},filtersConfig:{filterAttributes:[{name:x,loadOnChange:!1}],attributesConfig:{[x]:{value:r}}},afterClosed:m=>t._afterClosedLookupPageAction(e,m)}})()}_getSelectedIds(e){var t=this;return(0,n.A)(function*(){const s=yield t._getSelectedItems(e);return Promise.all(s.map(r=>r.Id))})()}_getSelectedItems(e){return e.$context[e.selectedItemsAttributeName]}_getItemsFilter(e){return e.filterAttributeName?e.$context[e.filterAttributeName]:Promise.resolve(null)}_getIsCreateEnabled(e){return e.enableAddRecord}_afterClosedLookupPageAction(e,t){var s=this;return(0,n.A)(function*(){if(t.canceled)return Promise.resolve();s._maskService.showMask(s._getMaskTaskName(e),e.$context);const r=yield s._getMergeIds(e,t);yield s._runAddRemoveActions(e,r),s._maskService.hideMask(s._getMaskTaskName(e),e.$context)})()}_getMaskTaskName(e){return`OpenSelectionWindow_${e.selectedItemsAttributeName}`}_getMergeIds(e,t){var s=this;return(0,n.A)(function*(){const r=yield s._getSelectedIds(e),i=(yield t.getLookupValues()).map(u=>u.value),m=i.filter(u=>!r.includes(u)),d=r.filter(u=>!i.includes(u));return{idsToAdd:m,idsToRemove:d}})()}_runAddRemoveActions(e,t){var s=this;return(0,n.A)(function*(){yield s._processAddCollectionItemsRequest(e,t.idsToAdd),yield s._processRemoveCollectionItemsRequest(e,t.idsToRemove)})()}_processAddCollectionItemsRequest(e,t){if(!t.length)return Promise.resolve();const s={type:"crt.AddSelectedItemsInRecordManualRequest",$context:e.$context,scopes:e.scopes,collectionAttributeName:e.selectedItemsAttributeName,selectedIds:t,selectColumnName:e.selectColumnName,recordRelationColumnName:e.recordRelationColumnName,recordId:e.recordId};return this.handlerChain.process(s)}_processRemoveCollectionItemsRequest(e,t){var s=this;return(0,n.A)(function*(){if(!t.length)return Promise.resolve();const r=yield s._getRelationRecordIds(e,t),i={type:"crt.RemoveCollectionItemsRequest",$context:e.$context,scopes:e.scopes,collectionAttributeName:e.selectedItemsAttributeName,primaryAttributeValues:r};return s.handlerChain.process(i)})()}_getRelationRecordIds(e,t){var s=this;return(0,n.A)(function*(){const r=yield s._getSelectedItems(e);return(yield Promise.all(r.map(function(){var m=(0,n.A)(function*(d){const u=yield d.Id;if(t.includes(u))return d[d.primaryAttributeName]});return function(d){return m.apply(this,arguments)}}()))).filter(Boolean)})()}handle(e){var t=this;return(0,n.A)(function*(){const s=yield t._getOpenLookupPageRequestConfig(e);yield t.handlerChain.process(s)})()}};P=(0,I.__decorate)([(0,a.CrtRequestHandler)({requestType:"crt.OpenBaseSelectSelectionWindowRequest",type:"crt.OpenBaseSelectSelectionWindowHandler"}),(0,I.__metadata)("design:paramtypes",[a.MaskService])],P);let E=class extends a.BaseRequest{};E=(0,I.__decorate)([(0,a.CrtRequest)({type:"crt.OpenBaseSelectSelectionWindowRequest"})],E)},73308:(O,y,l)=>{l.d(y,{A:()=>g});function A(a,f,v,c,h,p,_){try{var n=a[p](_),R=n.value}catch(k){v(k);return}n.done?f(R):Promise.resolve(R).then(c,h)}function g(a){return function(){var f=this,v=arguments;return new Promise(function(c,h){var p=a.apply(f,v);function _(R){A(p,c,h,_,n,"next",R)}function n(R){A(p,c,h,_,n,"throw",R)}_(void 0)})}}}}]);
