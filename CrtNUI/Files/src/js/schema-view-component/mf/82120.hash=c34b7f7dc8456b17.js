(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[82120,73308,50927,28546,6165,62832,40451,18070,95689,94260,71879,41421,63802,86183,8564,30945,53326,75707,98088,20469,42850,70422,48041,15184,92803,80898,58517,25660,3279,91374,68993,83231,5612,38469,59739],{59739:(v,L,u)=>{u.r(L),u.d(L,{ComboboxActionCodeEnum:()=>A,ComboboxDropdownPageSizeService:()=>y,ComboboxPreprocessorService:()=>R,ComboboxUtilsModule:()=>P,defaultAddRecordActionConfig:()=>V,defaultGoToRecordListActionConfig:()=>F});var M=u(40297),s=u(73308),S=u(31589),N=u(38495),D=u(79772),p=u(96590),c=u(21018),g=u(22438),b=u(10850),_=u(28399),m=u(62278),A;(function(x){x.AddRecord="addRecord",x.GoToRecordList="goToRecordList",x.OpenLookupPage="openLookupPage"})(A||(A={}));const V={code:A.AddRecord,type:"crt.ComboboxSearchTextAction",icon:"combobox-add-new",caption:"ComboBox.AddNewRecord",clicked:{request:"crt.CreateRecordFromLookupRequest",params:{}}},F={code:A.GoToRecordList,type:"crt.ComboboxAction",icon:"combobox-go-to-source",caption:"ComboBox.IsGoToSourceAllowedTooltip",clicked:{request:"crt.OpenLookupSourceRequest",params:{}}};var f=u(59131);class y{constructor(t){this._sysSettingsService=t,this._dropdownPageSizeFeatureName="DropdownPageSize",this._defaultDropdownPageSize=50,this._dropdownMinimumPageSize=10}_getSystemPageSize(){return(0,m.lastValueFrom)(this._sysSettingsService.getByCode(this._dropdownPageSizeFeatureName).pipe((0,m.map)(t=>this._parseSystemPagingSize(t.value)),(0,m.catchError)(()=>(0,m.of)(this._defaultDropdownPageSize))))}_getValidPageSize(t){return t>=this._dropdownMinimumPageSize?t:this._dropdownMinimumPageSize}_parseSystemPagingSize(t){const e=parseInt(t);return e||this._defaultDropdownPageSize}getPageSize(){var t=this;return(0,s.A)(function*(){const e=yield t._getSystemPageSize();return t._getValidPageSize(e)})()}static{this.\u0275fac=function(e){return new(e||y)(f.\u0275\u0275inject(c.BaseSysSettingsService))}}static{this.\u0275prov=f.\u0275\u0275defineInjectable({token:y,factory:y.\u0275fac,providedIn:"root"})}}class R{constructor(t,e,o,i,r,n){this._comboboxDropdownPageSizeService=t,this._translateService=e,this._dataSchemaRepository=o,this._rightsService=i,this._featureValues=r,this._window=n,this._disableLookupSelectionWindowFeatureName="DisableLookupSelectionWindow"}_getBindedAttributeName(t){return t.slice(1).split(".").pop()||""}_setComboboxInputs(t){this._setComboboxShowSecondaryDisplayValueState(t)}_setComboboxShowSecondaryDisplayValueState(t){t.showSecondaryDisplayValue=!!t.secondaryDisplayValue}_setComboboxShowListEvent(t,e){t.showList||(t.showList=this._createLoadDataRequestConfig(e,this._getAdditionalFilteredColumnPaths(t)),t.showList.params={...t.showList.params,config:{loadType:N.DataSourceLoadType.Reload}})}_setComboboxPaginationChange(t,e){t.paginationChange||(t.paginationChange=this._createLoadDataRequestConfig(e,this._getAdditionalFilteredColumnPaths(t)))}_createLoadDataRequestConfig(t,e){return{request:"crt.ComboboxLoadDataRequest",params:{dataSourceName:`${t}_DS`,parameters:[],primaryDisplayFilterValue:"@event.filterValue",additionalFilteredColumnPaths:e},useRelativeContext:!0}}_getAdditionalFilteredColumnPaths(t){const e=[];return t.showSecondaryDisplayValue&&e.push(t.secondaryDisplayValue),e}_setComboboxListActions(t,e){if(!t.listActions&&(t.listActions=[],t.isAddAllowed)){const i={...V,name:p.NameGenerator.generateUnique("ListAction")};t.listActions.push(i)}const o=this._findAddRecordListAction(t);if(o){const i=t.attributeName;o.clicked.params={...o.clicked.params,itemsAttributeName:`${e}`,attributeName:`${i}`,detail:"@event.detail"}}}_findAddRecordListAction(t){return t?.listActions?.find(e=>e.code===A.AddRecord)}_setComboboxControlActions(t,e){if(!t.controlActions&&(t.controlActions=[],t.isGoToSourceAllowed)){const r={...F,name:p.NameGenerator.generateUnique("ControlAction")};t.controlActions.push(r)}const o=t.controlActions.find(r=>r.code===A.GoToRecordList);o&&(o.clicked.params={itemsAttributeName:`${e}`});const i=t.controlActions.find(r=>r.code===A.OpenLookupPage);i&&(i.clicked.params={itemsAttributeName:`${e}`,itemAttributeName:`${t.attributeName}`})}_getReferenceSchemaName(t,e){const o=e[`${t.attributeName}_List`];return this._getEmbeddedEntitySchemaNameFromAttributeConfig(o)}_setComboboxLinkViewConfig(t,e){const o=t.items.slice(1),i=this._getReferenceSchemaName(t,e),r=this._translateService.instant("ComboBox.EmptyDisplayValue"),n=t.attributeName;t.linkViewConfig={type:"crt.Link",mode:"preventDefault",underlining:"hover",caption:`$${n} | crt.ToObjectProp : 'displayValue' : '${r}'`,href:`$${n} | crt.ToObjectProp : 'value' | crt.ToRecordLinkAsync : '${o}'`,clicked:{request:"crt.UpdateRecordRequest",params:{itemsAttributeName:n,recordId:`$${n} | crt.ToObjectProp : 'value'`,entityName:i}}}}_setComboboxConfig(t,e){this._setComboboxInputs(t),this._setComboboxShowListEvent(t,e),this._setComboboxListActions(t,e),this._setComboboxControlActions(t,e),this._setComboboxPaginationChange(t,e)}_checkEditPagesAndExtendWithLinkViewConfig(t,e,o){var i=this;return(0,s.A)(function*(){yield Promise.all(t.filter(r=>r.showValueAsLink).map(function(){var r=(0,s.A)(function*(n){(yield i._hasEditPage(n,e,o))&&i._setComboboxLinkViewConfig(n,e)});return function(n){return r.apply(this,arguments)}}()))})()}_addListAttribute(t,e){const o=t[e];t[e]={isCollection:!0,isLookup:!0,...o}}_addBusinessRuleListFilterAttribute(t,e){const o=(0,c.getBusinessRuleFilterAttributeName)(e);t[o]||(t[o]={value:{}})}_setEmbeddedModelIfNeed(t,e,o){var i=this;return(0,s.A)(function*(){const{vmListAttribute:r,model:n,comboboxAttributeName:a,vmAttribute:d}=t;if(i._isNotNeedAddedEmbeddedModel(r,a,o))return;const C=(yield i._getModelSchema(n))?.attributes?.find(({name:E})=>E===e)?.referenceSchemaName;C&&(r.embeddedModel=i._createEmbeddedModel((0,c.getItemsAttributeName)(a),C,d.modelConfig?.showDeactivatedRecords))})()}_isNotNeedAddedEmbeddedModel(t,e,o){return!!t.embeddedModel||this._isDataSourceExists(e,o)}_isDataSourceExists(t,e){const o=`${(0,c.getItemsAttributeName)(t)}_DS`;return!!this._getModelByDataSourceName(o,e)}_setViewModelConfig(t,e){var o=this;return(0,s.A)(function*(){const{vmListAttribute:i,model:r,comboboxAttributeName:n}=t;if(i.viewModelConfig)return;const d=(yield o._getModelSchema(r))?.findAttributeByName(e);if(!d){o._setEmptyViewModelConfig(t);return}const l=yield o._getDataSchema(d?.referenceSchemaName),h=o._createViewModelConfig((0,c.getItemsAttributeName)(n),l);o._setPrimaryColorConfigForViewModelConfigIfNeed(h,l,n),o._setSecondDisplayValueColumnPathConfigForViewModelConfigIfNeed(h,t,n),i.viewModelConfig=h})()}_setEmptyViewModelConfig(t){const{vmListAttribute:e,secondDisplayValueColumnPath:o}=t,i={};o&&(i.secondaryDisplayValue={}),e.viewModelConfig={attributes:{value:{},displayValue:{},primaryColorValue:{},...i}}}_setPrimaryColorConfigForViewModelConfigIfNeed(t,e,o){e?.primaryColorAttributeName&&(t.attributes.primaryColorValue={modelConfig:{path:`${(0,c.getItemsAttributeName)(o)}_DS.${e?.primaryColorAttributeName}`}})}_setSecondDisplayValueColumnPathConfigForViewModelConfigIfNeed(t,e,o){e.secondDisplayValueColumnPath&&(t.attributes.secondaryDisplayValue={modelConfig:{path:`${(0,c.getItemsAttributeName)(o)}_DS.${e.secondDisplayValueColumnPath}`}})}_getFilterAttributes(t,e){const o=t.modelConfig,i={name:(0,c.getBusinessRuleFilterAttributeName)((0,c.getItemsAttributeName)(e)),loadOnChange:!0},r=o?.filterAttributes??[];return r.find(n=>n.name===i.name)||r.push(i),r}_setModelConfig(t,e){var o=this;return(0,s.A)(function*(){const{vmListAttribute:i,model:r,comboboxAttributeName:n}=t,a=yield o._getModelConfigDefaultSorting(r,e),d=yield o._comboboxDropdownPageSizeService.getPageSize(),l=o._getFilterAttributes(i,n),h=o._createModelConfig((0,c.getItemsAttributeName)(n),a,d,l);o._mergeModelConfig(i,h)})()}_getModelConfigDefaultSorting(t,e){var o=this;return(0,s.A)(function*(){const i=[],n=(yield o._getModelSchema(t))?.findAttributeByName(e);if(n){const a=yield o._getDataSchema(n.referenceSchemaName),d=o._getDefaultSorting(a);d&&i.push(d)}return i})()}_getDefaultSorting(t){return t?.primaryDisplayAttributeName?{columnName:t?.primaryDisplayAttributeName,direction:"asc"}:null}_getDataSchema(t){var e=this;return(0,s.A)(function*(){let o;try{o=yield(0,m.lastValueFrom)(e._dataSchemaRepository.get(t),{defaultValue:null})}catch{o=null}return Promise.resolve(o)})()}_mergeModelConfig(t,e){const o=t.modelConfig;t.modelConfig=(0,_.merge)(e,o)}_getComboboxLookupModeFromDataSchema({attribute:t,models:e}){var o=this;return(0,s.A)(function*(){const i=o._getDataSourceNameFromAttributeConfig(t),r=o._getTargetFieldNameFromAttributeConfig(t),n=o._getModelByDataSourceName(i,e),d=(yield o._getModelSchema(n))?.findAttributeByName(r),l=S.LookupMode.List;return d?.lookupMode??l})()}_setComboboxMode({viewConfig:t,attributes:e,models:o,comboboxAttributeName:i}){var r=this;return(0,s.A)(function*(){const n=!r._featureValues[r._disableLookupSelectionWindowFeatureName];if(!(0,_.get)(r._window,"Terrasoft")?.isAngularHost||!n){t.mode=S.LookupMode.List;return}const d=e[i]??{};(0,b.isModelAttributeConfig)(d)&&(t.mode===void 0&&(t.mode=yield r._getComboboxLookupModeFromDataSchema({attribute:d,models:o})),t.mode===S.LookupMode.SelectionWindow&&r._setSelectionWindowAction(t,e))})()}_setComboboxListAttribute({attributes:t,models:e,comboboxAttributeName:o},i){var r=this;return(0,s.A)(function*(){const n=t[o]??{};if(!(0,b.isModelAttributeConfig)(n))return;const a=r._getDataSourceNameFromAttributeConfig(n),d=r._getTargetFieldNameFromAttributeConfig(n),l=t[(0,c.getItemsAttributeName)(o)],h=r._getModelByDataSourceName(a,e),C={vmListAttribute:l,model:h,comboboxAttributeName:o,vmAttribute:n,secondDisplayValueColumnPath:i};yield r._setEmbeddedModelIfNeed(C,d,e),yield r._setViewModelConfig(C,d),yield r._setModelConfig(C,d)})()}_setComboboxListSortingAttribute(t,e){const o=this._getComboboxListSortingAttributeName(e),i=t[o];t[o]={...i,isCollection:!0,viewModelConfig:{attributes:{columnName:{},direction:{}}}}}_getComboboxListSortingAttributeName(t){return`${t}_Sorting`}_hasEditPage(t,e,o){var i=this;return(0,s.A)(function*(){const r=i._getReferenceSchemaName(t,e);if(!r)return Promise.resolve(!1);const n={type:"crt.7XRequest",action:"HasEntityEditPage",$context:o,payload:{entityName:r}};return yield N.HandlerChainService.instance.process(n)})()}_createAttributeConfigByDataSchema(t,e){var o=this;return(0,s.A)(function*(){const i=o._getDefaultSorting(e),r=[];i&&r.push(i);const n=yield o._comboboxDropdownPageSizeService.getPageSize();return{isCollection:!0,isLookup:!0,embeddedModel:o._createEmbeddedModel(t,e.name),viewModelConfig:o._createViewModelConfig(t,e),modelConfig:o._createModelConfig(t,r,n,[])}})()}_createAndAddFilterAttribute(t){const e=t.filterAttributeName||`${t.listAttributeName}_Filter`,r=((t.attributes[t.listAttributeName]||{}).modelConfig||{}).filterAttributes||[];!!r.find(a=>a.name===e)||r.push({name:e,loadOnChange:!0}),t.attributes[e]={value:t.filter}}_createEmbeddedModel(t,e,o=!1){return{name:`${t}_DS`,config:{type:"crt.EntityDataSource",config:{entitySchemaName:e,useRecordDeactivation:!o}}}}_createViewModelConfig(t,e){const o={};return e?.primaryDisplayAttributeName&&(o.modelConfig={path:`${t}_DS.${e?.primaryDisplayAttributeName}`,ignoreValidators:!this._featureValues.DisableIgnoreLookupsDisplayValueValidators}),{attributes:{value:{modelConfig:{path:`${t}_DS.${e?.primaryAttributeName}`}},displayValue:o}}}_createModelConfig(t,e,o,i){return{path:`${t}_DS`,sortingConfig:{attributeName:this._getComboboxListSortingAttributeName(t),default:e},pagingConfig:{rowCount:o,rowsOffset:null},filterAttributes:i}}_getFiltersConfig(t,e){const i=t[e]?.modelConfig?.filterAttributes;if(!i)return null;const r={};return i.forEach(n=>{r[n.name]={value:"$"+n.name}}),{filterAttributes:i,attributesConfig:r}}_setSelectionWindowAction(t,e){const o=(0,c.getItemsAttributeName)(t.control).slice(1),i=t.attributeName,r=this._getReferenceSchemaName(t,e);if(!r||!i)return;const n=this._getFiltersConfig(e,o),a=!!this._findAddRecordListAction(t),l=!!(e[i]??{}).modelConfig?.showDeactivatedRecords;t.selectionWindowIconPressed={request:"crt.OpenSelectionWindowRequest",useRelativeContext:!0,params:{itemAttributeName:i,entitySchemaName:r,filtersConfig:n,features:{showDeactivatedRecords:l,create:{enabled:a}}}}}_actualizeComboboxAddRecordAction(t,e,o){var i=this;return(0,s.A)(function*(){if(i._featureValues.DisableCheckingForAddRecordActionInCombobox)return;const r=t.filter(l=>!!i._findAddRecordListAction(l)),n=yield i._getViewConfigsWithEditPage(r,e,o),a=i._getDifferentElementsInConfigCollections(r,n),d=yield i._getIsNotAllowedAddRecordActionViewConfigs(n,e);[...a,...d].forEach(l=>i._disableAddRecordAction(l))})()}_getDifferentElementsInConfigCollections(t,e){return t.filter(o=>!e.some(i=>o.attributeName===i.attributeName))}_getViewConfigsWithEditPage(t,e,o){var i=this;return(0,s.A)(function*(){return(yield Promise.all(t.map(function(){var r=(0,s.A)(function*(n){return(yield i._isViewConfigIfWithoutEditPage(n,e,o))?null:n});return function(n){return r.apply(this,arguments)}}()))).filter(r=>!!r)})()}_isViewConfigIfWithoutEditPage(t,e,o){var i=this;return(0,s.A)(function*(){return!i._getReferenceSchemaName(t,e)||!(yield i._hasEditPage(t,e,o))})()}_getIsNotAllowedAddRecordActionViewConfigs(t,e){var o=this;return(0,s.A)(function*(){if(!t||t.length===0)return[];const i=yield o._getIsNotAllowedAddRecordActionSchemaNames(t,e);return t.filter(r=>i.includes(o._getReferenceSchemaName(r,e)))})()}_getIsNotAllowedAddRecordActionSchemaNames(t,e){var o=this;return(0,s.A)(function*(){const i=[...new Set(t?.map(n=>o._getReferenceSchemaName(n,e)))];return(yield(0,m.lastValueFrom)(o._rightsService.getCanAdd(i).pipe((0,m.catchError)(()=>(0,m.of)(null)))))?.filter(n=>!n.result).map(n=>n.schemaName)??[]})()}_disableAddRecordAction(t){this._removeAddRecordAction(t),this._disableAddRecordInSelectionWindow(t)}_removeAddRecordAction(t){const e=this._findAddRecordListAction(t);t.listActions=t.listActions.filter(o=>o!==e)}_disableAddRecordInSelectionWindow(t){const o=(t.selectionWindowIconPressed?.params?.features||{}).create||{};o.enabled=!1}_setActivityResultFilters(t,e,o){var i=this;return(0,s.A)(function*(){(yield i._isNeedAddActivityResultFilter(t,e,o))&&i._addActivityResultFiltersAttributes(t,o)})()}_isNeedAddActivityResultFilter(t,e,o){var i=this;return(0,s.A)(function*(){const r=t[o],n=i._getDataSourceNameFromAttributeConfig(r);if((0,_.isEmpty)(n))return!1;const a=i._getModelByDataSourceName(n,e);if((yield i._getModelSchema(a))?.name!=="Activity")return!1;const l=(0,c.getItemsAttributeName)(o),h=t[l];return i._getEmbeddedEntitySchemaNameFromAttributeConfig(h)==="ActivityResult"})()}_getModelSchema(t){return(0,m.lastValueFrom)(t.getSchema(),{defaultValue:null})}_getEmbeddedEntitySchemaNameFromAttributeConfig(t){return t&&"embeddedModel"in t&&t.embeddedModel?.config?.config?.entitySchemaName}_getModelByDataSourceName(t,e){return e.find(o=>o.name===t)}_addActivityResultFiltersAttributes(t,e){const o=(0,c.getItemsAttributeName)(e),i=t[e],r=this._getDataSourceNameFromAttributeConfig(i);this._createResultByCategoryFilterAttribute(t,o,r)}_getDataSourceNameFromAttributeConfig(t){return t.modelConfig?.path.split(".")[0]}_getTargetFieldNameFromAttributeConfig(t){return t.modelConfig?.path.split(".").pop()}_createResultByCategoryFilterAttribute(t,e,o){const i=`${e}_CategoryFilter`;this._createAndAddFilterAttribute({attributes:t,listAttributeName:e,filter:null,filterAttributeName:i}),t[i]={from:[this._getOrCreateAttributeByModelConfigPath(`${o}.ActivityCategory`,t),this._getOrCreateAttributeByModelConfigPath(`${o}.AllowedResult`,t)],converter:"crt.ActivityResultsFilters"}}_getOrCreateAttributeByModelConfigPath(t,e){const o=this._findAttributeByModelConfigPath(t,e);return o||this._createAttributeWithModelConfigPath(t,e)}_findAttributeByModelConfigPath(t,e){return Object.keys(e).find(o=>(e[o]??{}).modelConfig?.path===t)}_createAttributeWithModelConfigPath(t,e){const o=t.replace(".","_");return e[o]={modelConfig:{path:t}},o}crtOnMetaDataInit(t,e){t=t.filter(o=>(0,g.isBindToViewModelAttribute)(o.control,e)),t.forEach(o=>{const i=o.control,r=this._getBindedAttributeName(i),n=o.items,a=(0,c.getItemsAttributeName)(r);if((0,g.isBindToViewModelAttribute)(n,e)){const d=n.slice(1).split(".").pop();e[d].isLookup=!0}else this._addListAttribute(e,a),o.items=(0,c.getItemsAttributeName)(i);this._addBusinessRuleListFilterAttribute(e,a),o.attributeName=r,this._setComboboxConfig(o,a)})}crtOnModelInit(t,e,o){var i=this;return(0,s.A)(function*(){t=t.filter(r=>(0,g.isBindToViewModelAttribute)(r.control,e)),yield Promise.all(t.map(function(){var r=(0,s.A)(function*(n){const a=i._getBindedAttributeName(n.control);i._setComboboxListSortingAttribute(e,(0,c.getItemsAttributeName)(a)),yield i._setComboboxListAttribute({attributes:e,models:o,comboboxAttributeName:a},n.showSecondaryDisplayValue?n.secondaryDisplayValue:""),yield i._setActivityResultFilters(e,o,a)});return function(n){return r.apply(this,arguments)}}()))})()}crtOnViewModelInit(t,e,o,i){var r=this;return(0,s.A)(function*(){t=t.filter(n=>(0,g.isBindToViewModelAttribute)(n.items,e)),yield r._checkEditPagesAndExtendWithLinkViewConfig(t,e,i),yield r._actualizeComboboxAddRecordAction(t,e,i),yield Promise.all(t.filter(n=>(0,g.isBindingExpression)(n.control)).map(function(){var n=(0,s.A)(function*(a){const d=r._getBindedAttributeName(a.control);yield r._setComboboxMode({viewConfig:a,attributes:e,models:o,comboboxAttributeName:d})});return function(a){return n.apply(this,arguments)}}()))})()}setupComboboxMetadataByEntitySchema(t,e,o,i){var r=this;return(0,s.A)(function*(){const n=yield r._getDataSchema(o);if(!n)return;const a=(0,c.getItemsAttributeName)(t.name);e[a]=yield r._createAttributeConfigByDataSchema(a,n),i&&r._createAndAddFilterAttribute({attributes:e,listAttributeName:a,filter:i}),r._setComboboxListSortingAttribute(e,a),t.items=`$${a}`,r._setComboboxShowListEvent(t,a),r._setComboboxPaginationChange(t,a)})()}static{this.\u0275fac=function(e){return new(e||R)(f.\u0275\u0275inject(y),f.\u0275\u0275inject(D.TranslateService),f.\u0275\u0275inject(b.DataSchemaRepositoryService),f.\u0275\u0275inject(c.BaseRightsService),f.\u0275\u0275inject(c.FEATURE_VALUES),f.\u0275\u0275inject(p.WINDOW_TOKEN))}}static{this.\u0275prov=f.\u0275\u0275defineInjectable({token:R,factory:R.\u0275fac})}}class P{static{this.\u0275fac=function(e){return new(e||P)}}static{this.\u0275mod=f.\u0275\u0275defineNgModule({type:P})}static{this.\u0275inj=f.\u0275\u0275defineInjector({providers:[R,y],imports:[M.CommonModule]})}}(function(){(typeof ngJitMode>"u"||ngJitMode)&&f.\u0275\u0275setNgModuleScope(P,{imports:[M.CommonModule]})})()},73308:(v,L,u)=>{u.d(L,{A:()=>s});function M(S,N,D,p,c,g,b){try{var _=S[g](b),m=_.value}catch(A){D(A);return}_.done?N(m):Promise.resolve(m).then(p,c)}function s(S){return function(){var N=this,D=arguments;return new Promise(function(p,c){var g=S.apply(N,D);function b(m){M(g,p,c,b,_,"next",m)}function _(m){M(g,p,c,b,_,"throw",m)}b(void 0)})}}}}]);
